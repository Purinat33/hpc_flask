{% extends "base.html" %}
{% block title %}Audit Log{% endblock %}

{% block content %}
<h2>Audit Log</h2>
<p class="muted">Newest 100 actions are shown here. Use the CSV for the full history.</p>

<div class="layout">
    <!-- Sidebar copied from your Admin page -->
    <aside class="sidebar">
        <a class="slink" href="{{ url_for('admin.admin_form', section='rates',  type='mu') }}">{{ _("Change Rate")
            }}</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='usage',  type='mu') }}">{{ _("Usage Tables")
            }}</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='myusage') }}">{{ _("My Usage") }}</a>
        <a class="slink {{ 'on' if section=='billing' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing', bview=bview or 'invoices') }}">{{ _("Invoices") }}</a>
        <a class="slink on" href="{{ url_for('admin.audit_page') }}">{{ _("Audit Log") }}</a>
        <a class="slink {{ 'on' if section=='dashboard' else '' }}"
            href="{{ url_for('admin.admin_form', section='dashboard', before=before) }}">
            {{ _("Dashboard") }}
        </a>
        <!-- <a class="slink" href="{{ url_for('admin.ledger_page') }}">Accounting</a> -->
        <a class="slink" href="{{ url_for('admin.admin_form', section='tiers') }}">User Tier Overrides</a>

    </aside>

    <main>
        <div class="card">
            <div style="margin-bottom:.5rem">
                <a href="{{ url_for('admin.audit_csv') }}"><button type="button">Download CSV (all)</button></a>
                <button type="button" id="btnVerify">Verify log integrity</button>
            </div>
            <div id="verifyStatus" class="muted" style="margin:-.25rem 0 .75rem 0; min-height:1.25rem;" aria-live="polite"
                aria-atomic="true"></div>
<div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Time (GMT+7)</th>
                        <th>Actor</th>
                        <th>Action</th>
                        <th>Target</th>
                        <th>Method</th>
                        <th>Path</th>
                        <th>IP</th>
                        <th>Status</th>
                        <th>Outcome</th>
                        <th>Error</th>
                        <th>Role</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r.ts|dt_local }}</td>
                        <td>{{ r.actor or '—' }}</td>
                        <td>{{ r.action }}</td>
                        <td>{{ r.target or '—' }}</td>
                        <td>{{ r.method or '—' }}</td>
                        <td>{{ r.path or '—' }}</td>
                        <td>{{ r.ip or '—' }}</td>
                        <td>{{ r.status or '—' }}</td>
                        <td>{{ r.outcome or '—' }}</td>
                        <td>{{ r.error_code or '—' }}</td>
                        <td>{{ r.actor_role or '—' }}</td>
                    </tr>
                    {% endfor %}
                    {% if not rows or rows|length == 0 %}
                    <tr>
                        <td colspan="8" class="muted">No audit events yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('btnVerify');
        const status = document.getElementById('verifyStatus');

        function setStatus(html, tone) {
            // tone: 'ok' | 'bad' | 'warn' | 'info'
            const colors = {
                ok: 'color:#0a7a0a',     // green
                bad: 'color:#b00020',     // red
                warn: 'color:#9a6b00',     // amber
                info: 'color:inherit'
            };
            status.style.cssText = "margin:-.25rem 0 .75rem 0; min-height:1.25rem;" + (colors[tone] ? ';' + colors[tone] : '');
            status.innerHTML = html;
        }

        btn?.addEventListener('click', async () => {
            btn.disabled = true;
            const original = btn.textContent;
            btn.textContent = 'Verifying…';
            setStatus('Running integrity check…', 'info');

            try {
                const res = await fetch('{{ url_for("admin.audit_verify_json") }}', { credentials: 'same-origin' });
                const data = await res.json();

                if (res.ok && data.ok) {
                    setStatus(
                        `✔️ <strong>Log Chain OK</strong> — checked <code>${data.checked}</code> entr${data.checked === 1 ? 'y' : 'ies'}, last OK id <code>${data.last_ok_id ?? '—'}</code>.`,
                        'ok'
                    );
                } else {
                    const reason = data?.reason || 'unknown';
                    setStatus(
                        `❌ <strong>Log chain compromised</strong> — reason <code>${reason}</code>. `
                        + `Last OK id <code>${data?.last_ok_id ?? '—'}</code>, first bad id <code>${data?.first_bad_id ?? '—'}</code>.`,
                        'bad'
                    );
                }
            } catch (e) {
                setStatus(`⚠️ Verification error: <code>${(e && e.message) ? e.message : e}</code>.`, 'warn');
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        });
    });
</script>

{% endblock %}
