{% extends "base.html" %}
{% block title %}User Tier Overrides{% endblock %}
{% block content %}
<h2>User Tier Overrides</h2>
<p class="muted">Pick a tier per user. If you pick the same tier as the natural classifier, we remove the override.</p>

<form method="post" action="{{ url_for('admin.save_tiers') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="toolbar" style="display:flex;gap:.75rem;align-items:center;margin-bottom:12px;">
        <input id="userFilter" type="search" placeholder="Filter users…" value="" aria-label="Filter users"
            style="max-width:280px;padding:.5rem .6rem;border:1px solid #ddd;border-radius:6px;">
        <span class="muted">Showing <strong id="matchCount">{{ rows|length }}</strong> of {{ rows|length }}</span>
        <button type="button" id="clearFilter" class="linklike" style="margin-left:auto;">Clear</button>
    </div>
    <table id="tiersTable">
        <thead>
            <tr>
                <th>User</th>
                <th>Tier</th>
                <th>Overridden?</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr data-username="{{ r.username|lower }}">
                <td>{{ r.username }}</td>
                <td>
                    {% for t in tiers %}
                    <label style="margin-right:12px;">
                        <input type="radio" name="tier_{{ r.username }}" value="{{ t }}" {{ 'checked' if r.tier==t
                            else '' }}>
                        {{ t.upper() }}
                    </label>
                    {% endfor %}
                </td>
                <td>{{ 'YES' if r.overridden else 'NO' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p><button type="submit">Save</button></p>
</form>

{% if notes and notes|length %}
<div class="card">
    <h3>Notes</h3>
    <ul>{% for n in notes %}<li>{{ n }}</li>{% endfor %}</ul>
</div>
{% endif %}
<script>
    (function () {
        const input = document.getElementById('userFilter');
        const clearBtn = document.getElementById('clearFilter');
        const table = document.getElementById('tiersTable');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const count = document.getElementById('matchCount');

        function applyFilter(q) {
            const qq = (q || "").toLowerCase().trim();
            let shown = 0;
            rows.forEach(tr => {
                // match on username (data-username) or full text if you prefer
                const u = tr.dataset.username || tr.textContent.toLowerCase();
                const hit = !qq || u.includes(qq);
                tr.style.display = hit ? "" : "none";
                if (hit) shown++;
            });
            if (count) count.textContent = shown;
        }

        input.addEventListener('input', () => applyFilter(input.value));

        clearBtn?.addEventListener('click', () => {
            input.value = "";
            input.focus();
            applyFilter("");
        });

        // Optional: restore filter from URL ?q=… if you decide to wire it later
        const params = new URLSearchParams(location.search);
        if (params.has('q')) {
            input.value = params.get('q');
        }
        applyFilter(input.value);
    })();
</script>

{% endblock %}
