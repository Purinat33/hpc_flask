{% extends "base.html" %}
{% block title %}Accounting & Reversal Signals{% endblock %}
{% block content %}
<h2>Accounting</h2>
<p class="muted">Mode: ({{ 'preview/derived' if request.args.get('mode') == 'derived' else 'posted' }})</p>
{% with msgs = get_flashed_messages(with_categories=true) %}
{% if msgs %}
<div class="flash-wrap">
    {% for cat, m in msgs %}
    <div class="flash {{cat}}">{{ m }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
<style>
    .flash-wrap {
        margin: .5rem 0
    }

    .flash {
        padding: .5rem .75rem;
        border-radius: 8px;
        background: #f6f7f9;
    }

    .flash.error {
        background: #fde7ea;
        color: #a11;
    }

    .flash.success {
        background: #e8f6ee;
        color: #0a5;
    }
</style>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <a class="slink" href="{{ url_for('admin.admin_form', section='rates',  type='mu') }}">Change Rate</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='usage',  type='mu') }}">Usage Tables</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='myusage') }}">My Usage</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='billing', bview='invoices') }}">Invoices</a>
        <a class="slink" href="{{ url_for('admin.audit_page') }}">Audit Log</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='dashboard') }}">Dashboard</a>
        <a class="slink on" href="{{ url_for('admin.ledger_page') }}">Accounting</a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='tiers') }}">User Tier Overrides</a>
        <a class="slink" href="{{ url_for('admin.list_export_runs') }}">Exports</a>
    </aside>

    <!-- Main -->
    <main>
        <p class="muted">
            Window: <b>{{ start }}</b> ‚Üí <b>{{ end }}</b>
        </p>

        <div class="toolbar" style="margin-bottom:.75rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
            <form method="get" action="{{ url_for('admin.ledger_page') }}" style="display:flex; gap:.5rem; align-items:center;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="date" name="start" value="{{ start }}">
                <span>‚Üí</span>
                <input type="date" name="end" value="{{ end }}">
                <button type="submit">Apply</button>
            </form>
            <a class="muted" href="{{ url_for('admin.ledger_page', start=this_month_start, end=this_month_end) }}"><button>This
            month</button></a>
            <a class="muted" href="{{ url_for('admin.ledger_page', start=last_month_start, end=last_month_end) }}"><button>Last
            month</button></a>
            <a class="muted" href="{{ url_for('admin.ledger_page', start=ytd_start, end=this_month_end) }}"><button>YTD</button></a>
            <a href="{{ url_for('admin.ledger_csv', start=start, end=end) }}"><button>Download Preview CSV</button></a>
        <!-- templates/admin/ledger.html  (ADD near your date pickers) -->
        <form method="post" action="{{ url_for('admin.ui_close_period', year=period_year, month=period_month) }}"
            style="display:inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            {% if period_status == 'closed' %}
            <button formaction="{{ url_for('admin.ui_reopen_period', year=period_year, month=period_month) }}">
                üîì Reopen {{ "%04d-%02d"|format(period_year, period_month) }}
            </button>
            {% else %}
            <button>
                üîí Close {{ "%04d-%02d"|format(period_year, period_month) }}
            </button>
            {% endif %}
            <span class="muted">Status: {{ period_status }}</span>
        </form>
        <!-- templates/admin/ledger.html ‚Äì inside the toolbar block near your date filters -->
        <form method="post" action="{{ url_for('admin.export_gl_formal_zip') }}"
            style="display:flex; gap:.5rem; align-items:center;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- we export exactly the visible window -->
            <input type="hidden" name="start" value="{{ start }}">
            <input type="hidden" name="end" value="{{ end }}">
        
            {% set can_export = (export_stats.batches or 0) > 0 %}
            <button type="submit" {% if not can_export %}disabled title="Nothing new to export in this window" {% endif %}>
                ‚¨áÔ∏è Formal GL Export (ZIP)
            </button>
        
            <span class="muted">
                {{ export_stats.batches }} batch{{ '' if (export_stats.batches==1) else 'es' }},
                {{ export_stats.lines }} line{{ '' if (export_stats.lines==1) else 's' }} to export
            </span>
        
            <a href="{{ url_for('admin.list_export_runs') }}">
                <button type="button">Past Export Runs</button>
            </a>
        </form>


        </div>


        <!-- KPI chips -->
        <div class="kpis">
            <div class="chip">
                <div class="klabel">Paid invoices</div>
                <div class="kval">{{ kpis.count_paid }}</div>
            </div>
            <div class="chip">
                <div class="klabel">Sum paid (window)</div>
                <div class="kval">‡∏ø{{ '%.2f'|format(kpis.sum_paid or 0) }}</div>
            </div>
            <div class="chip {{ 'ok' if (kpis.count_eligible or 0) > 0 else '' }}">
                <div class="klabel">Eligible to Revert</div>
                <div class="kval">{{ kpis.count_eligible }}</div>
            </div>
            <div class="chip {{ 'ok' if (export_stats.batches or 0)>0 else '' }}">
                <div class="klabel">Unexported Batches (window)</div>
                <div class="kval">{{ export_stats.batches }}</div>
            </div>
            <div class="chip {{ 'ok' if (export_stats.lines or 0)>0 else '' }}">
                <div class="klabel">Unexported Lines (window)</div>
                <div class="kval">{{ export_stats.lines }}</div>
            </div>
        </div>

        <!-- Safety signals table -->
        <div class="card" style="margin:1rem 0;">
            <div style="display:flex;align-items:center;gap:.5rem;">
                <h3 style="margin:0;">Paid Receipts (window)</h3>
                <span class="muted">Only receipts with <b>no external payment</b> and <b>no downstream locks</b> are
                    eligible for a safe revert.</span>
            </div>
            <div class="table-wrap" style="max-height:320px;overflow:auto;margin-top:.5rem;">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Invoice #</th>
                            <th class="num">Total</th>
                            <th>Paid At</th>
                            <th>External Payment?</th>
                            <th>GL Exported?</th>
                            <th>E-Tax</th>
                            <th>Customer Sent?</th>
                            <th>Eligible to Revert?</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in paid_receipts %}
                        <tr>
                            <td>{{ r.id }}</td>
                            <td>{{ r.username }}</td>
                            <td>{{ r.invoice_no or '‚Äî' }}</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(r.total or 0) }}</td>
                            <td>{{ r.paid_at.isoformat().replace('+00:00', 'Z') if r.paid_at else '‚Äî' }}</td>

                            <!-- External payment -->
                            <td>
                                {% if r.has_external_payment %}
                                <span class="tag bad">Yes</span>
                                {% else %}
                                <span class="tag ok">No</span>
                                {% endif %}
                            </td>

                            <!-- GL exported -->
                            <td>
                                {% if r.exported_to_gl_at %}
                                <span class="tag bad" title="{{ r.exported_to_gl_at }}">Yes</span>
                                {% else %}
                                <span class="tag">‚Äî</span>
                                {% endif %}
                            </td>

                            <!-- E-Tax status -->
                            <td>
                                {% if r.etax_submitted_at %}
                                <span class="tag bad" title="{{ r.etax_submitted_at }}">Submitted</span>
                                {% elif r.etax_status %}
                                <span
                                    class="tag {{ 'ok' if r.etax_status|lower in ['draft','none',''] else 'warn' }}">{{ r.etax_status }}</span>
                                {% else %}
                                <span class="tag">‚Äî</span>
                                {% endif %}
                            </td>

                            <!-- Customer sent -->
                            <td>
                                {% if r.customer_sent_at %}
                                <span class="tag warn" title="{{ r.customer_sent_at }}">Sent</span>
                                {% else %}
                                <span class="tag">‚Äî</span>
                                {% endif %}
                            </td>

                            <!-- Eligible -->
                            <td>
                                {% if r.eligible_to_revert %}
                                <span class="tag ok">Yes</span>
                                {% else %}
                                <span class="tag bad">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <details style="margin-top:.5rem;">
                <summary>Revert policy (why this matters)</summary>
                <ul style="margin:.5rem 1.25rem;">
                    <li><b>External payment = Yes</b> ‚ü∂ do <i>not</i> revert; use a refund/credit note.</li>
                    <li><b>GL Exported / E-Tax Submitted / Customer Sent = Yes</b> ‚ü∂ do <i>not</i> revert; post reversal
                        in downstream systems.</li>
                    <li>Only revert for administrative corrections before downstream actions.</li>
                </ul>
            </details>
        </div>

        <!-- Existing 3-column grid: Trial Balance, P&L/BS, Journal -->
        <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap:1rem;">
            <div class="card">
                <h3>Trial Balance</h3>
                <small>Œ£ Debits: {{ tb_meta.sum_debits }} ‚Ä¢ Œ£ Credits: {{ tb_meta.sum_credits }} ‚Ä¢ Œî:
                    {{ tb_meta.out_of_balance }}</small>
                <div class="table-wrap" style="max-height:320px;overflow:auto;margin-top:.5rem;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Type</th>
                                <th class="num">Debits</th>
                                <th class="num">Credits</th>
                                <th class="num">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in tb %}
                            <tr>
                                <td>{{ r.account_id }} ‚Äî {{ r.account_name }}</td>
                                <td>{{ r.account_type }}</td>
                                <td class="num">{{ '%.2f'|format(r.debits or 0) }}</td>
                                <td class="num">{{ '%.2f'|format(r.credits or 0) }}</td>
                                <td class="num">{{ '%.2f'|format(r.balance or 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Income Statement</h3>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Revenue</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(pnl.Revenue or 0) }}</td>
                        </tr>
                        <tr>
                            <td>Expenses</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(pnl.Expenses or 0) }}</td>
                        </tr>
                        <tr>
                            <th>Net Income</th>
                            <th class="num">‡∏ø{{ '%.2f'|format(pnl.Net_Income or 0) }}</th>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top:1rem;">Balance Sheet (Snapshot)</h3>
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>Assets</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(bs.Assets or 0) }}</td>
                        </tr>
                        <tr>
                            <td>Liabilities</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(bs.Liabilities or 0) }}</td>
                        </tr>
                        <tr>
                            <td>Equity + P&L</td>
                            <td class="num">‡∏ø{{ '%.2f'|format(bs.Equity_Including_PnL or 0) }}</td>
                        </tr>
                        <tr>
                            <th>Check (A ‚àí L ‚àí E)</th>
                            <th class="num">{{ '%.2f'|format(bs["Check(Assets - L-E)"] or 0) }}</th>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3>Journal (lines)</h3>
                <div class="table-wrap" style="max-height:320px;overflow:auto;margin-top:.5rem;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ref</th>
                                <th>Memo</th>
                                <th>Account</th>
                                <th class="num">Dr</th>
                                <th class="num">Cr</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for l in journal %}
                            <tr>
                                <td>{{ l.date }}</td>
                                <td>{{ l.ref }}</td>
                                <td>{{ l.memo }}</td>
                                <td>{{ l.account_id }} ‚Äî {{ l.account_name }}</td>
                                <td class="num">{{ '%.2f'|format(l.debit or 0) }}</td>
                                <td class="num">{{ '%.2f'|format(l.credit or 0) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <style>
            .num {
                text-align: right;
            }

            .table-wrap {
                border: 1px solid #eee;
                border-radius: 6px;
            }

            .kpis {
                display: flex;
                gap: .75rem;
                flex-wrap: wrap;
                margin: .5rem 0 0;
            }

            .chip {
                background: #f7f7f9;
                border: 1px solid #eee;
                border-radius: 10px;
                padding: .5rem .75rem;
            }

            .chip.ok {
                background: #f2fbf5;
                border-color: #c9efcf;
            }

            .klabel {
                font-size: .8rem;
                color: #666;
            }

            .kval {
                font-weight: 700;
                font-size: 1.1rem;
            }

            .tag {
                display: inline-block;
                padding: .1rem .4rem;
                border-radius: 6px;
                font-size: .75rem;
                background: #f0f0f0;
            }

            .tag.ok {
                background: #e5f7ea;
                color: #0a5;
            }

            .tag.bad {
                background: #fde7ea;
                color: #c11;
            }

            .tag.warn {
                background: #fff5d6;
                color: #a76b00;
            }
        </style>
    </main>
</div>

<style>
    /* Match the other admin pages */
    .layout {
        display: grid;
        grid-template-columns: 220px minmax(0, 1fr);
        gap: 1rem;
        align-items: start;
    }

    .sidebar {
        position: sticky;
        top: 0;
        align-self: start;
    }
</style>
{% endblock %}
