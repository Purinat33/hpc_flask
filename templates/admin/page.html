{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
<h2>{{ _("Admin") }}</h2>
<p class="muted">
    {% trans user=current_user.username, role=current_user.role %}
    Signed in as <b>{{ user }}</b> (role: {{ role }})
    {% endtrans %}
</p>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <a class="slink {{ 'on' if section=='rates' else '' }}"
            href="{{ url_for('admin.admin_form', section='rates', type=tier) }}">{{ _("Change Rate") }}</a>

        <a class="slink {{ 'on' if section=='usage' else '' }}"
            href="{{ url_for('admin.admin_form', section='usage', type=tier, start=start, end=end, view=view) }}">{{
            _("Usage Tables") }}</a>

        <a class="slink {{ 'on' if section=='myusage' else '' }}"
            href="{{ url_for('admin.admin_form', section='myusage', before=before, view=view) }}">{{ _("My Usage")
            }}</a>

        <a class="slink {{ 'on' if section=='billing' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing') }}">{{ _("Billing") }}</a>
    </aside>

    <!-- Main -->
    <main>
        {# ================= RATES ================= #}
        {% if section == 'rates' %}
        <div class="card">
            <h3>{{ _("Change Rate") }}</h3>
            <form method="post" action="{{ url_for('admin.admin_update') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label>Tier</label>
                <select name="type">
                    <option value="mu" {% if tier=='mu' %}selected{% endif %}>mu</option>
                    <option value="gov" {% if tier=='gov' %}selected{% endif %}>gov</option>
                    <option value="private" {% if tier=='private' %}selected{% endif %}>private</option>
                </select>

                <div class="row">
                    <div>
                        <label>CPU (à¸¿/cpu-hour)
                            <input type="number" step="0.01" min="0" name="cpu"
                                value="{{ '%.2f'|format(current['cpu']) }}">
                        </label>
                    </div>
                    <div>
                        <label>GPU (à¸¿/gpu-hour)
                            <input type="number" step="0.01" min="0" name="gpu"
                                value="{{ '%.2f'|format(current['gpu']) }}">
                        </label>
                    </div>
                </div>

                <label>MEM (à¸¿/GB-hour)
                    <input type="number" step="0.01" min="0" name="mem" value="{{ '%.2f'|format(current['mem']) }}">
                </label>

                <div class="muted">
                    <span class="chip">Selected: {{ tier|upper }}</span>
                    <span class="chip">CPU: à¸¿{{ '%.2f'|format(current['cpu']) }}</span>
                    <span class="chip">GPU: à¸¿{{ '%.2f'|format(current['gpu']) }}</span>
                    <span class="chip">MEM: à¸¿{{ '%.2f'|format(current['mem']) }}</span>
                </div>

                <button type="submit">Update</button>
            </form>
        </div>

        <div class="card">
            <h3>{{ _("Current Rates (All Tiers)") }}</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>CPU</th>
                        <th>GPU</th>
                        <th>MEM</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name in tiers %}
                    {% set r = all_rates.get(name, {'cpu':0,'gpu':0,'mem':0}) %}
                    <tr class="{{ 'active' if name==tier else '' }}">
                        <td class="tier">{{ name|upper }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['cpu']) }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['gpu']) }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['mem']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# ================= ALL-USERS USAGE ================= #}
        {% elif section == 'usage' %}
        <div class="card">
            <h3>{{ _("Usage Preview")}} (slurmrestd â†’ sacct â†’ test.csv)</h3>

            <form method="get">
                <div class="grid2">
                    <div>
                        <label>Jobs completed before
                            <input type="date" name="before" value="{{ before }}">
                        </label>
                    </div>
                    <div><label>&nbsp;<button type="submit">Fetch Usage</button></label></div>
                </div>
                <input type="hidden" name="section" value="usage">
                <input type="hidden" name="type" value="{{ tier }}">
            </form>

            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}"
                    href="{{ url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail') }}">Detailed</a>
                <a class="{{ 'on' if view=='aggregate' else '' }}"
                    href="{{ url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate') }}">Aggregate</a>
            </div>

            <div class="right muted">
                Source: <b>{{ data_source or 'â€”' }}</b>{% if notes and notes|length>0 %} â€” {{ notes|join(' | ') }}{%
                endif %}
            </div>
            <div class="clear"></div>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>JobID</th>
                        <th>Elapsed</th>
                        <th>TotalCPU</th>
                        <th>ReqTRES</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>Tier</th>
                        <th>State</th>
                        <th>Cost (à¸¿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['JobID'] }}</td>
                        <td>{{ r['Elapsed'] }}</td>
                        <td>{{ r['TotalCPU'] }}</td>
                        <td>{{ r['ReqTRES'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['State'] }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['Cost (à¸¿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs: {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% else %}
            {% if agg_rows and agg_rows|length>0 %}
            <p class="muted"><span class="chip">Grand total: à¸¿{{ '%.2f'|format(grand_total) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>Total Cost (à¸¿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['Cost (à¸¿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs: {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}
        </div>

        {# ================= ADMIN'S OWN USAGE ================= #}
        {% elif section == 'myusage' %}
        <div class="card">
            <h3>{{ _("Usage Preview") }}</h3>

            <form method="get">
                <div class="grid2">
                    <div>
                        <label>Jobs completed before
                            <input type="date" name="before" value="{{ before }}">
                        </label>
                    </div>
                    <div><label>&nbsp;<button type="submit">Fetch</button></label></div>
                </div>
                <input type="hidden" name="section" value="myusage">
            </form>

            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='detail') }}">{{
                    _("Detailed") }}</a>
                <a class="{{ 'on' if view=='aggregate' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='aggregate') }}">{{
                    _("Aggregate") }}</a>
                <a class="{{ 'on' if view=='billed' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='billed') }}">{{
                    _("Billed") }}</a>
            </div>

            {% if view in ['detail','aggregate'] %}
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>{{ _("Your Jobs") }}</h3>
                <div>
                    <a href="{{ url_for('admin.my_usage_csv_admin', before=before) }}"><button type="button">Download
                            CSV</button></a>
                </div>
            </div>

            <form method="post" action="{{ url_for('admin.create_self_receipt') }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="before" value="{{ before }}">
                <button type="submit">{{ _("Create Receipt") }}</button>
            </form>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <p class="muted">
                <span class="chip">Jobs: {{ rows|length }}</span>
                <span class="chip">Total: à¸¿{{ '%.2f'|format(grand_total) }}</span>
            </p>
            <table>
                <thead>
                    <tr>
                        <th>JobID</th>
                        <th>Elapsed</th>
                        <th>TotalCPU</th>
                        <th>ReqTRES</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>State</th>
                        <th>Tier</th>
                        <th>Cost (à¸¿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r['JobID'] }}</td>
                        <td>{{ r['Elapsed'] }}</td>
                        <td>{{ r['TotalCPU'] }}</td>
                        <td>{{ r['ReqTRES'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>{{ r['State'] }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['Cost (à¸¿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% else %} {# aggregate #}
            {% if agg_rows and agg_rows|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>Total Cost (à¸¿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['Cost (à¸¿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}

            {% else %} {# view == 'billed' #}
            <h4>Pending (unpaid) receipts</h4>
            {% if my_pending_receipts and my_pending_receipts|length>0 %}
            <p class="muted"><span class="chip">Total: à¸¿{{ '%.2f'|format(sum_pending) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Period</th>
                        <th>Total (à¸¿)</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in my_pending_receipts %}
                    <tr>
                        <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                        <td>{{ r['start'] }} â†’ {{ r['end'] }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['created_at'] }}</td>
                        <td>
                            <form method="post" action="{{ url_for('admin.mark_paid', rid=r['id']) }}"
                                style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit">{{ _("Mark as paid") }}</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">Nothing pending ðŸŽ‰</p>
            {% endif %}

            <h4 style="margin-top:1rem">Paid receipts</h4>
            {% if my_paid_receipts and my_paid_receipts|length>0 %}
            <p class="muted"><span class="chip">Total: à¸¿{{ '%.2f'|format(sum_paid) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Period</th>
                        <th>Total (à¸¿)</th>
                        <th>Paid at</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in my_paid_receipts %}
                    <tr>
                        <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                        <td>{{ r['start'] }} â†’ {{ r['end'] }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['paid_at'] or 'â€”' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No paid receipts yet.</p>
            {% endif %}
            {% endif %}
        </div>

        {# ================= BILLING (ALL USERS) ================= #}
        {% elif section == 'billing' %}
        <div class="card">
            <h3>{{ _("Pending Receipts")}}</h3>
            {% if pending and pending|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Period</th>
                        <th>Total (à¸¿)</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in pending %}
                    <tr>
                        <td>#{{ r['id'] }}</td>
                        <td>{{ r['username'] }}</td>
                        <td>{{ r['start'] }} â†’ {{ r['end'] }}</td>
                        <td>à¸¿{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['created_at'] }}</td>
                        <td>
                            <form method="post" action="{{ url_for('admin.mark_paid', rid=r['id']) }}"
                                style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit">{{ _("Mark as paid") }}</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">Nothing pending ðŸŽ‰</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>{{ _("Download Payment History")}}</h3>
            <p class="muted">Exports all <b>paid</b> receipts.</p>
            <a href="{{ url_for('admin.paid_csv') }}"><button type="button">Download paid history (CSV)</button></a>
        </div>
        {% endif %}
    </main>
</div>
{% endblock %}
