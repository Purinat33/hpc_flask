{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
<h2>Admin</h2>
<p class="muted">Signed in as <b>{{ current_user.username }}</b> (role: {{ current_user.role }})</p>


<div class="layout">
    <aside class="sidebar">
        <a class="slink {{ 'on' if section=='rates' else '' }}"
            href="{{ url_for('admin.admin_form', section='rates', type=tier) }}">Change Rate</a>
        <a class="slink {{ 'on' if section=='usage' else '' }}"
            href="{{ url_for('admin.admin_form', section='usage', type=tier, start=start, end=end, view=view) }}">Usage
            Tables</a>
        <a class="slink {{ 'on' if section=='billing' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing') }}">Billing</a>
    </aside>

    <main>
        {% if section == 'rates' %}
        <div class="card">
            {% with messages = get_flashed_messages() %}
            {% if messages %}{% for m in messages %}<div>{{ m }}</div>{% endfor %}{% endif %}
            {% endwith %}

            <h3>Change Rate</h3>
            <form method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label>Tier</label>
                <select name="type">
                    <option value="mu" {% if tier=='mu' %}selected{% endif %}>mu</option>
                    <option value="gov" {% if tier=='gov' %}selected{% endif %}>gov</option>
                    <option value="private" {% if tier=='private' %}selected{% endif %}>private</option>
                </select>
                <div class="row">
                    <div><label>CPU (฿/cpu-hour)<input type="number" step="0.01" min="0" name="cpu"
                                value="{{ '%.2f'|format(current['cpu']) }}"></label></div>
                    <div><label>GPU (฿/gpu-hour)<input type="number" step="0.01" min="0" name="gpu"
                                value="{{ '%.2f'|format(current['gpu']) }}"></label></div>
                </div>
                <label>MEM (฿/GB-hour)<input type="number" step="0.01" min="0" name="mem"
                        value="{{ '%.2f'|format(current['mem']) }}"></label>
                <div class="muted">
                    <span class="chip">Selected: {{ tier|upper }}</span>
                    <span class="chip">CPU: ฿{{ '%.2f'|format(current['cpu']) }}</span>
                    <span class="chip">GPU: ฿{{ '%.2f'|format(current['gpu']) }}</span>
                    <span class="chip">MEM: ฿{{ '%.2f'|format(current['mem']) }}</span>
                </div>
                <button type="submit">Update</button>
            </form>
        </div>

        <div class="card">
            <h3>Current Rates (All Tiers)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>CPU</th>
                        <th>GPU</th>
                        <th>MEM</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name in tiers %}
                    {% set r = all_rates.get(name, {'cpu':0,'gpu':0,'mem':0}) %}
                    <tr class="{{ 'active' if name==tier else '' }}">
                        <td class="tier">{{ name|upper }}</td>
                        <td>฿{{ '%.2f'|format(r['cpu']) }}</td>
                        <td>฿{{ '%.2f'|format(r['gpu']) }}</td>
                        <td>฿{{ '%.2f'|format(r['mem']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% elif section == 'usage' %}
        <div class="card">
            <h3>Usage Preview (slurmrestd → sacct → test.csv)</h3>
            <form method="get">
                <div class="grid2">
                    <div>
                        <label>Jobs completed before
                            <input type="date" name="before" value="{{ before }}">
                        </label>
                    </div>
                    <div><label>&nbsp;<button type="submit">Fetch Usage</button></label></div>
                </div>
                <input type="hidden" name="section" value="usage">
                <input type="hidden" name="type" value="{{ tier }}">
            </form>


            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}"
                    href="{{ url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail') }}">Detailed</a>
                <a class="{{ 'on' if view=='aggregate' else '' }}"
                    href="{{ url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate') }}">Aggregate</a>
            </div>

            <div class="right muted">Source: <b>{{ data_source or '—' }}</b>{% if notes and notes|length>0 %} — {{
                notes|join(' | ') }}{% endif %}</div>
            <div class="clear"></div>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>JobID</th>
                        <th>Elapsed</th>
                        <th>TotalCPU</th>
                        <th>ReqTRES</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>Tier</th>
                        <th>State</th>
                        <th>Cost (฿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['JobID'] }}</td>
                        <td>{{ r['Elapsed'] }}</td>
                        <td>{{ r['TotalCPU'] }}</td>
                        <td>{{ r['ReqTRES'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['State'] }}</td>
                        <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs: {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% else %}
            {% if agg_rows and agg_rows|length>0 %}
            <p class="muted"><span class="chip">Grand total: ฿{{ '%.2f'|format(grand_total) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs</th>
                        <th>Total Cost (฿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                        <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs: {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}
        </div>

        {% elif section == 'billing' %}
        <div class="card">
            <h3>Pending Receipts</h3>
            {% if pending and pending|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Period</th>
                        <th>Total (฿)</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in pending %}
                    <tr>
                        <td>#{{ r['id'] }}</td>
                        <td>{{ r['username'] }}</td>
                        <td>{{ r['start'] }} → {{ r['end'] }}</td>
                        <td>฿{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['created_at'] }}</td>
                        <td>
                            <form method="post" action="{{ url_for('admin.mark_paid', rid=r['id']) }}"
                                style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit">Mark as paid</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">Nothing pending 🎉</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Download Payment History</h3>
            <p class="muted">Exports all <b>paid</b> receipts.</p>
            <a href="{{ url_for('admin.paid_csv') }}"><button type="button">Download paid history (CSV)</button></a>
        </div>
        {% endif %}
    </main>
</div>
{% endblock %}
