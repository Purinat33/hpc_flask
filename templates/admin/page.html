{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
<h2>{{ _("Admin") }}</h2>
<p class="muted">
    {% trans user=current_user.username, role=current_user.role %}
    Signed in as <b>{{ user }}</b> (role: {{ role }})
    {% endtrans %}
</p>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <a class="slink {{ 'on' if section=='rates' else '' }}"
            href="{{ url_for('admin.admin_form', section='rates', type=tier) }}">{{ _("Change Rate") }}</a>

        <a class="slink {{ 'on' if section=='usage' else '' }}"
            href="{{ url_for('admin.admin_form', section='usage', type=tier, start=start, end=end, view=view) }}">{{ _("Usage Tables") }}</a>

        <a class="slink {{ 'on' if section=='myusage' else '' }}"
            href="{{ url_for('admin.admin_form', section='myusage', before=before, view=view) }}">{{ _("My Usage") }}</a>

        <a class="slink {{ 'on' if section=='billing' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing', bview=bview or 'invoices') }}">{{ _("Invoices") }}</a>

        <a class="slink {{ 'on' if section=='audit' else '' }}" href="{{ url_for('admin.audit_page') }}">Audit Log</a>

        <a class="slink {{ 'on' if section=='dashboard' else '' }}"
            href="{{ url_for('admin.admin_form', section='dashboard', before=before) }}">{{ _("Dashboard") }}</a>

        <a class="slink {{ 'on' if section=='tiers' else '' }}"
            href="{{ url_for('admin.admin_form', section='tiers') }}">{{ _("User Tier Overrides") }}</a>
        <!-- <a class="slink" href="{{ url_for('admin.ledger_page') }}">Accounting</a> -->
    </aside>

    <style>
        .grid2.controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: .75rem 1rem;
            align-items: end;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field>label {
            margin-bottom: .25rem;
        }

        .actions {
            display: flex;
            gap: .5rem;
            align-self: end;
        }

        .hl-primary {
            font-weight: 700;
            text-decoration: underline;
            font-style: italic;
        }

        .hl-fallback1 {
            font-weight: 700;
            text-decoration: underline;
        }

        .hl-fallback2 {
            font-weight: 700;
            font-style: italic;
        }

        .formula small {
            color: var(--muted, #666);
        }

        details.raw {
            margin-top: .75rem;
        }

        .table-wrap {
            position: relative;
            max-height: 60vh;
            overflow: auto;
            border: 1px solid var(--bd);
            border-radius: 10px;
        }

        .table-wrap>table {
            width: 100%;
            border: 0;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0;
        }

        .table-wrap thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #f8fafc;
            box-shadow: 0 1px 0 var(--bd);
        }

        .table-wrap th,
        .table-wrap td {
            overflow-wrap: anywhere;
        }

        .chip {
            display: inline-block;
            padding: .1rem .4rem;
            border-radius: .6rem;
            background: #efefef;
            margin-right: .25rem;
        }

        .tabs {
            display: flex;
            gap: .5rem;
            margin: .5rem 0;
        }

        .tabs a {
            padding: .25rem .5rem;
            border-radius: .5rem;
            text-decoration: none;
            border: 1px solid var(--bd);
        }

        .tabs a.on {
            background: #eef2ff;
            border-color: #c7d2fe;
        }

        .muted small {
            color: var(--muted, #666);
        }

        .right {
            float: right
        }

        .clear {
            clear: both
        }
    </style>

    <!-- Main -->
    <main>

        {# ================= RATES ================= #}
        {% if section == 'rates' %}
        <div class="card">
            <h3>{{ _("Change Rate") }}</h3>
            <form method="post" action="{{ url_for('admin.admin_update') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label>Tier</label>
                <select id="tierSelect" name="type">
                    <option value="mu" {{ 'selected' if tier=='mu' else '' }}>mu</option>
                    <option value="gov" {{ 'selected' if tier=='gov' else '' }}>gov</option>
                    <option value="private" {{ 'selected' if tier=='private' else '' }}>private</option>
                </select>

                <script>
                    (function () {
                        const sel = document.getElementById('tierSelect');
                        const baseUrl = "{{ url_for('admin.admin_form', section='rates') }}";
                        sel.addEventListener('change', (e) => {
                            const u = new URL(baseUrl, window.location.origin);
                            u.searchParams.set('type', e.target.value);
                            window.location.assign(u.toString());
                        });
                    })();
                </script>

                <div class="row">
                    <div>
                        <label>CPU (฿/cpu-hour)
                            <input type="number" step="0.01" min="0" name="cpu"
                                value="{{ '%.2f'|format(current['cpu']) }}">
                        </label>
                    </div>
                    <div>
                        <label>GPU (฿/gpu-hour)
                            <input type="number" step="0.01" min="0" name="gpu"
                                value="{{ '%.2f'|format(current['gpu']) }}">
                        </label>
                    </div>
                </div>

                <label>MEM (฿/GB-hour)
                    <input type="number" step="0.01" min="0" name="mem" value="{{ '%.2f'|format(current['mem']) }}">
                </label>

                <div class="muted">
                    <span class="chip">Selected: {{ tier|upper }}</span>
                    <span class="chip">CPU: ฿{{ '%.2f'|format(current['cpu']) }}</span>
                    <span class="chip">GPU: ฿{{ '%.2f'|format(current['gpu']) }}</span>
                    <span class="chip">MEM: ฿{{ '%.2f'|format(current['mem']) }}</span>
                </div>
                <br>
                <button type="submit">Update</button>
            </form>
        </div>

        <div class="card">
            <h3>{{ _("Current Rates (All Tiers)") }}</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>CPU</th>
                        <th>GPU</th>
                        <th>MEM</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name in tiers %}
                    {% set r = all_rates.get(name, {'cpu':0,'gpu':0,'mem':0}) %}
                    <tr class="{{ 'active' if name==tier else '' }}">
                        <td class="tier">{{ name|upper }}</td>
                        <td>฿{{ '%.2f'|format(r['cpu']) }}</td>
                        <td>฿{{ '%.2f'|format(r['gpu']) }}</td>
                        <td>฿{{ '%.2f'|format(r['mem']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# ================= ALL-USERS USAGE ================= #}
        {% elif section == 'usage' %}
        <div class="card">
            <h3>{{ _("Usage Preview")}} (slurmrestd → sacct → test.csv)</h3>

            <form method="get" autocomplete="off" id="usage-form">
                <div class="grid2 controls">
                    <div class="field">
                        <label for="before">Jobs completed before</label>
                        <input id="before" type="date" name="before" value="{{ before }}">
                    </div>
                    <div class="field">
                        <label for="q-inp">Filter by user</label>
                        <small id="q-counter" class="muted" style="display:block;margin-top:.25rem"></small>
                        <input id="q-inp" name="q" type="search" value="{{ q or '' }}"
                            placeholder="Start typing a username" list="userlist" autocomplete="off" spellcheck="false"
                            autocapitalize="off" autocorrect="off" data-1p-ignore="true" data-lpignore="true">
                        <datalist id="userlist">
                            {% for u in all_users %}
                            <option value="{{ u }}"></option>
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="actions">
                        <button type="submit">Fetch Usage</button>
                        <button type="button" id="reset-q" class="btn-secondary">Reset Search</button>
                    </div>
                </div>
                <input type="hidden" name="section" value="usage">
                <input type="hidden" name="type" value="{{ tier }}">
            </form>

            <div class="right muted">
                Source: <b>{{ data_source or '—' }}</b>{% if notes and notes|length>0 %} —
                {{ notes|join(' | ') }}{% endif %}
            </div>
            <div class="clear"></div>

            {# Legend + footnotes retained #}
            <div class="formula" style="margin:.5rem 0 .25rem 0">
                <div>
                    <b>CPU</b>:
                    <span class="hl-primary">
                        <abbr
                            title="Total CPU time consumed per step (HH:MM:SS). We sum across all steps of the job and convert to hours.">Σ
                            TotalCPU (steps)</abbr>
                        <a href="#fn-totalcpu" class="fn">[1]</a>
                    </span>
                    <small>or</small>
                    <span class="hl-fallback1">
                        <abbr title="CPU time in seconds (integer). Divide by 3600 to get hours.">CPUTimeRAW /
                            3600</abbr>
                        <a href="#fn-cputimeraw" class="fn">[2]</a>
                    </span>
                    <small>or</small>
                    <span class="hl-fallback2">
                        <abbr title="Allocated CPU cores from TRES × wall-clock runtime (hours).">AllocCPUS ×
                            Elapsed</abbr>
                        <a href="#fn-alloccpus" class="fn">[3]</a><a href="#fn-elapsed" class="fn">[4]</a>
                    </span>
                </div>

                <div>
                    <b>MEM</b>:
                    <span class="hl-primary">
                        <abbr
                            title="Average resident set size per step (converted to GB) × the step’s wall-clock hours, summed over steps.">Σ
                            AveRSS(GB) × Elapsed (steps)</abbr>
                        <a href="#fn-averss" class="fn">[5]</a><a href="#fn-elapsed" class="fn">[4]</a>
                    </span>
                    <small>or</small>
                    <span class="hl-fallback2">
                        <abbr title="Memory allocated (GB) parsed from TRES mem= × wall-clock hours.">Mem_from_TRES ×
                            Elapsed</abbr>
                        <a href="#fn-memfromtres" class="fn">[6]</a><a href="#fn-elapsed" class="fn">[4]</a>
                    </span>
                </div>

                <div>
                    <b>GPU</b>:
                    <span class="hl-primary">
                        <abbr title="Number of GPUs allocated (from AllocTRES) × wall-clock hours.">AllocGPU ×
                            Elapsed</abbr>
                        <a href="#fn-allocgpu" class="fn">[7]</a><a href="#fn-elapsed" class="fn">[4]</a>
                    </span>
                    <small>or</small>
                    <span class="hl-fallback2">
                        <abbr
                            title="Requested GPUs (from ReqTRES) × wall-clock hours (fallback if AllocTRES lacks GPU).">ReqGPU
                            × Elapsed</abbr>
                        <a href="#fn-reqgpu" class="fn">[8]</a><a href="#fn-elapsed" class="fn">[4]</a>
                    </span>
                </div>
            </div>

            <details class="footnotes">
                <summary>What do these variables mean?</summary>
                <ol class="fn-list">
                    <li id="fn-totalcpu"><span class="fn-var">TotalCPU</span> — Slurm field (HH:MM:SS[.fff]) per
                        job/step; sum, convert to core-hours.</li>
                    <li id="fn-cputimeraw"><span class="fn-var">CPUTimeRAW</span> — CPU seconds; divide by 3600.</li>
                    <li id="fn-alloccpus"><span class="fn-var">AllocCPUS</span> — from <span
                            class="fn-var">AllocTRES</span> / <span class="fn-var">ReqTRES</span>.</li>
                    <li id="fn-elapsed"><span class="fn-var">Elapsed</span> — D-HH:MM:SS; convert to hours.</li>
                    <li id="fn-averss"><span class="fn-var">AveRSS</span> — average RSS per step; convert to GB.</li>
                    <li id="fn-memfromtres"><span class="fn-var">Mem_from_TRES</span> — mem= in TRES, GB.</li>
                    <li id="fn-allocgpu"><span class="fn-var">AllocGPU</span> — gres/gpu= in AllocTRES.</li>
                    <li id="fn-reqgpu"><span class="fn-var">ReqGPU</span> — fallback from ReqTRES.</li>
                </ol>
                <div class="muted" style="margin-top:.25rem">
                    Notes: “steps” like <span class="fn-var">.batch</span>, <span class="fn-var">.0</span> roll up to
                    parent job or array task.
                </div>
            </details>

            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}" href="{{ q
               and url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail', q=q)
               or  url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail') }}">
                    Detailed
                </a>
                <a class="{{ 'on' if view=='aggregate' else '' }}" href="{{ q
               and url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate', q=q)
               or  url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate') }}">
                    Aggregate
                </a>
            </div>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <div class="table-wrap" id="usage-detail-wrap">
                <table id="usage-detail">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>JobID</th>
                            <th>Elapsed</th>
                            <th>End</th>
                            <th>State</th>
                            <th>CPU core-hrs</th>
                            <th>GPU (count)</th>
                            <th>GPU hrs</th>
                            <th>Mem (GB alloc)</th>
                            <th>Mem GB-hrs <small>(used)</small></th>
                            <th>Mem GB-hrs <small>(alloc)</small></th>
                            <th>Tier</th>
                            <th>Cost (฿)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr>
                            <td>{{ r['User'] }}</td>
                            <td>{{ r['JobID'] }}</td>
                            <td>{{ r['Elapsed'] }}</td>
                            <td>{{ r['End']|dt_local }}</td>
                            <td>{{ r['State'] }}</td>
                            <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                            <td>{{ r['GPU_Count'] }}</td>
                            <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                            <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                            <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                            <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                            <td>{{ r['tier']|upper }}</td>
                            <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs (used): {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}

            <details class="raw">
                <summary>Show raw fetched data (parents + steps)</summary>
                {% if raw_cols and raw_rows %}
                <div class="table-wrap">
                    <table id="usage-raw">
                        <thead>
                            <tr>{% for c in raw_cols %}<th>{{ c }}</th>{% endfor %}</tr>
                        </thead>
                        <tbody>
                            {% for r in raw_rows %}
                            <tr>{% for c in raw_cols %}<td>{{ r.get(c) }}</td>{% endfor %}</tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="muted" style="margin-top:.25rem">Showing first {{ raw_rows|length }} row(s).</p>
                {% else %}
                <p class="muted">No raw rows.</p>
                {% endif %}
            </details>

            {% else %}
            {% if agg_rows and agg_rows|length>0 %}
            <p class="muted"><span class="chip">Grand total: ฿{{ '%.2f'|format(grand_total) }}</span></p>
            <table id="usage-agg">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs (used)</th>
                        <th>Total Cost (฿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs (used): {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}
        </div>

        {# ================= ADMIN'S OWN USAGE (Billed tab removed; no "Create Receipt") ================= #}
        {% elif section == 'myusage' %}
        <div class="card">
            <h3>{{ _("Usage Preview") }}</h3>

            <form method="get">
                <div class="grid2">
                    <div>
                        <label>Jobs completed before
                            <input type="date" name="before" value="{{ before }}">
                        </label>
                    </div>
                    <div><label>&nbsp;<button type="submit">Fetch</button></label></div>
                </div>
                <input type="hidden" name="section" value="myusage">
            </form>

            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='detail') }}">{{ _("Detailed") }}</a>
                <a class="{{ 'on' if view=='aggregate' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='aggregate') }}">{{ _("Aggregate") }}</a>
            </div>

            {% if view in ['detail','aggregate'] %}
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>{{ _("Your Jobs") }}</h3>
                <div>
                    <a href="{{ url_for('admin.my_usage_csv_admin', before=before) }}"><button type="button">Download
                            CSV</button></a>
                </div>
            </div>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <p class="muted">
                <span class="chip">Jobs: {{ rows|length }}</span>
                <span class="chip">Total: ฿{{ '%.2f'|format(grand_total) }}</span>
            </p>
            <table>
                <thead>
                    <tr>
                        <th>JobID</th>
                        <th>Elapsed</th>
                        <th>End</th>
                        <th>State</th>
                        <th>CPU core-hrs</th>
                        <th>GPU (count)</th>
                        <th>GPU hrs</th>
                        <th>Mem (GB alloc)</th>
                        <th>Mem GB-hrs <small>(used)</small></th>
                        <th>Mem GB-hrs <small>(alloc)</small></th>
                        <th>Tier</th>
                        <th>Cost (฿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r['JobID'] }}</td>
                        <td>{{ r['Elapsed'] }}</td>
                        <td>{{ r['End']|dt_local }}</td>
                        <td>{{ r['State'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ r['GPU_Count'] }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% else %} {# aggregate #}
            {% if agg_rows and agg_rows|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs (used)</th>
                        <th>Total Cost (฿)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}
            {% endif %}
        </div>

        {# ================= INVOICES (ALL USERS) — payments removed, add "Trend & Monthly" ================= #}
{% elif section == 'billing' %}
<div class="card">
    <h3>{{ _("Invoices")}}</h3>

    <div class="tabs">
        <a class="{{ 'on' if (bview or 'invoices')=='invoices' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing', bview='invoices') }}">Invoices</a>
        <a class="{{ 'on' if bview=='trend' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing', bview='trend', year=year or '', u=selected_user or '', month=month or '') }}">
            Trend & Monthly
        </a>
    </div>

    {% if (bview or 'invoices') == 'invoices' %}
    <!-- Create Monthly Invoices -->
    <form method="post" action="{{ url_for('admin.create_month_invoices') }}" style="margin:.5rem 0;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>Year
            <input type="number" name="year" min="2000" max="2100" step="1" value="{{ (year or '') or current_year }}">
        </label>
        <label style="margin-left:.5rem;">Month
            <select name="month" required>
                {% for m in range(1,13) %}
                <option value="{{ m }}" {{ 'selected' if (month and m==month|int) else '' }}>{{ "%02d"|format(m) }}
                </option>
                {% endfor %}
            </select>
        </label>
        <button type="submit" style="margin-left:.5rem;">Create Monthly Invoices</button>
        <small class="muted" style="margin-left:.5rem;">Creates one pending invoice per user for the chosen
            month.</small>
    </form>

    <h4>{{ _("Pending Invoices") }}</h4>
    {% if pending and pending|length>0 %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Period</th>
                <th>Total (฿)</th>
                <th>Created</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for r in pending %}
            <tr>
                <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                <td>{{ r['username'] }}</td>
                <td>{{ r['start']|dt_local }} → {{ r['end']|dt_local }}</td>
                <td>฿{{ '%.2f'|format(r['total']) }}</td>
                <td>{{ r['created_at']|dt_local }}</td>
                <td>{{ r['status'] }}</td>
                <td>
                    <form method="post" action="{{ url_for('admin.mark_paid', rid=r['id']) }}" style="display:inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit">{{ _("Mark as paid") }}</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">Nothing pending 🎉</p>
    {% endif %}

    <div class="card" style="margin-top:1rem">
        <h4>{{ _("Paid Invoices") }}</h4>
        {% if paid and paid|length>0 %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Period</th>
                    <th>Total (฿)</th>
                    <th>Paid at</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for r in paid %}
                <tr>
                    <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                    <td>{{ r['username'] }}</td>
                    <td>{{ r['start']|dt_local }} → {{ r['end']|dt_local }}</td>
                    <td>฿{{ '%.2f'|format(r['total']) }}</td>
                    <td>{{ r['paid_at']|dt_local or '—' }}</td>
                    <td>{{ r['status'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top:.5rem">
            <a href="{{ url_for('admin.paid_csv') }}"><button type="button">Download paid history (CSV)</button></a>
        </div>
        {% else %}
        <p class="muted">No paid invoices yet.</p>
        {% endif %}
    </div>

            {% else %} {# bview == 'trend' #}
            {# ===== Filters: pick user + year + (optional) month ===== #}
            <form method="get" autocomplete="off" style="margin-bottom:.75rem">
                <div class="grid2 controls" style="grid-template-columns: 1fr 1fr 1fr auto;">
                    <div class="field">
                        <label for="u">User</label>
                        <input id="u" name="u" type="search" value="{{ selected_user or '' }}" placeholder="username"
                            list="userlist2" autocomplete="off" spellcheck="false">
                        <datalist id="userlist2">
                            {% for u in all_users %}<option value="{{ u }}"></option>{% endfor %}
                        </datalist>
                    </div>
                    <div class="field">
                        <label for="year">Year</label>
                        <input id="year" name="year" type="number" min="2000" max="2100" step="1"
                            value="{{ year or current_year }}">
                    </div>
                    <div class="field">
                        <label for="month">Month (optional)</label>
                        <select id="month" name="month">
                            <option value="">—</option>
                            {% for m in range(1,13) %}
                            <option value="{{ m }}" {{ 'selected' if month and m==month|int else '' }}>
                                {{ "%02d"|format(m) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="actions">
                        <input type="hidden" name="section" value="billing">
                        <input type="hidden" name="bview" value="trend">
                        <button type="submit">Apply</button>
                    </div>
                </div>
            </form>

            {% if selected_user %}
            <h4 style="margin:.25rem 0">{{ selected_user }} — {{ year or current_year }}</h4>

            {# --- Monthly trend (aggregated) --- #}
            <div class="card" style="margin-top:.5rem">
                <h3>Monthly totals (aggregated)</h3>
                {% if monthly_agg and monthly_agg|length>0 %}
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Jobs</th>
                            <th>CPU core-hrs</th>
                            <th>GPU hrs</th>
                            <th>Mem GB-hrs (used)</th>
                            <th>Total Cost (฿)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in monthly_agg %}
                        <tr>
                            <td>{{ "%02d"|format(r['month']) }}</td>
                            <td>{{ r['jobs'] }}</td>
                            <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                            <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                            <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                            <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p class="muted" style="margin-top:.25rem">
                    <span class="chip">Year total: ฿{{ '%.2f'|format(year_total or 0) }}</span>
                </p>
                {% else %}
                <p class="muted">No usage for this year/user.</p>
                {% endif %}
            </div>

            {# --- Optional monthly detail (when a month is chosen) --- #}
            {% if month and month_detail_rows %}
            <div class="card" style="margin-top:1rem">
                <h3>Details for {{ selected_user }} — {{ year or current_year }}-{{ "%02d"|format(month|int) }}</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>JobID</th>
                                <th>Elapsed</th>
                                <th>End</th>
                                <th>State</th>
                                <th>CPU core-hrs</th>
                                <th>GPU (count)</th>
                                <th>GPU hrs</th>
                                <th>Mem (GB alloc)</th>
                                <th>Mem GB-hrs <small>(used)</small></th>
                                <th>Mem GB-hrs <small>(alloc)</small></th>
                                <th>Tier</th>
                                <th>Cost (฿)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in month_detail_rows %}
                            <tr>
                                <td>{{ r['JobID'] }}</td>
                                <td>{{ r['Elapsed'] }}</td>
                                <td>{{ r['End']|dt_local }}</td>
                                <td>{{ r['State'] }}</td>
                                <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                                <td>{{ r['GPU_Count'] }}</td>
                                <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                                <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                                <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                                <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                                <td>{{ r['tier']|upper }}</td>
                                <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="muted" style="margin-top:.5rem">
                    <span class="chip">Jobs: {{ month_detail_rows|length }}</span>
                    <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu_m or 0) }}</span>
                    <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu_m or 0) }}</span>
                    <span class="chip">Mem GB-hrs (used): {{ '%.2f'|format(tot_mem_m or 0) }}</span>
                    <span class="chip">Total: ฿{{ '%.2f'|format(month_total or 0) }}</span>
                </div>
            </div>
            {% endif %}

            {% else %}
            <p class="muted">Choose a user and year to view monthly trends and (optionally) a month’s detailed usage.
            </p>
            {% endif %}
            {% endif %}
        </div>

        {% else %}
        <p class="muted">Unknown section.</p>
        {% endif %}
    </main>
</div>

<script>
    function syncTabLinks(q) {
        const tabs = document.querySelectorAll('.tabs a');
        tabs.forEach(a => {
            const url = new URL(a.href, window.location.origin);
            if ((q || '').trim()) { url.searchParams.set('q', q); }
            else { url.searchParams.delete('q'); }
            a.href = url.toString();
        });
    }

    (function () {
        const form = document.getElementById('usage-form');
        const inp = document.getElementById('q-inp');
        const resetBtn = document.getElementById('reset-q');
        const counter = document.getElementById('q-counter');

        const tblDetail = document.getElementById('usage-detail');
        const tblAgg = document.getElementById('usage-agg');
        const tblRaw = document.getElementById('usage-raw');

        const debounce = (fn, ms = 150) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), ms); }; };

        function findUserColIndex(table) {
            if (!table) return -1;
            const ths = table.querySelectorAll('thead th');
            for (let i = 0; i < ths.length; i++) {
                if ((ths[i].textContent || '').trim().toLowerCase() === 'user') return i;
            }
            return -1;
        }

        function filterTableByUser(table, q) {
            if (!table) return { shown: 0, total: 0 };
            const userCol = findUserColIndex(table);
            if (userCol === -1) return { shown: 0, total: 0 };
            const rows = table.querySelectorAll('tbody tr');
            const qq = (q || '').trim().toLowerCase();
            let shown = 0;
            rows.forEach(tr => {
                const cells = tr.children;
                const userText = (cells[userCol]?.textContent || '').toLowerCase();
                const match = !qq || userText.includes(qq);
                tr.style.display = match ? '' : 'none';
                if (match) shown++;
            });
            return { shown, total: rows.length };
        }

        function updateCounter(q) {
            if (!counter) return;
            const a = filterTableByUser(tblDetail, q);
            const b = filterTableByUser(tblAgg, q);
            const c = filterTableByUser(tblRaw, q);
            const totals = [a, b, c].filter(x => x.total > 0);
            if (totals.length === 0) { counter.textContent = ''; return; }
            const shown = totals.reduce((s, x) => s + x.shown, 0);
            const total = totals.reduce((s, x) => s + x.total, 0);
            counter.textContent = (q || '').trim()
                ? `Showing ${shown} of ${total} row(s) for “${q}” (local filter)`
                : `Showing all ${total} row(s)`;
        }

        function applyFilter() {
            const q = inp ? inp.value : '';
            filterTableByUser(tblDetail, q);
            filterTableByUser(tblAgg, q);
            filterTableByUser(tblRaw, q);
            updateCounter(q);
            syncTabLinks(q);
        }

        const applyFilterDebounced = debounce(applyFilter, 150);

        if (inp) {
            inp.addEventListener('focus', function () {
                if (!this.value) {
                    const v = this.value;
                    this.value = ' ';
                    this.dispatchEvent(new Event('input', { bubbles: true }));
                    setTimeout(() => { this.value = v; }, 10);
                }
            });
            inp.addEventListener('input', applyFilterDebounced);
        }

        if (resetBtn && inp) {
            resetBtn.addEventListener('click', function () {
                inp.value = '';
                applyFilter();
                if (history && history.replaceState) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('q');
                    history.replaceState({}, '', url.toString());
                }
            });
        }

        applyFilter();
    })();
</script>
{% endblock %}
