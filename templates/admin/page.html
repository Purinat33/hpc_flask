{% extends "base.html" %}
{% block title %}Admin{% endblock %}

{% block content %}
<h2>{{ _("Admin") }}</h2>
<p class="muted">
    {% trans user=current_user.username, role=current_user.role %}
    Signed in as <b>{{ user }}</b> (role: {{ role }})
    {% endtrans %}
</p>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <a class="slink {{ 'on' if section=='rates' else '' }}"
            href="{{ url_for('admin.admin_form', section='rates', type=tier) }}">{{ _("Change Rate") }}</a>

        <a class="slink {{ 'on' if section=='usage' else '' }}"
            href="{{ url_for('admin.admin_form', section='usage', type=tier, start=start, end=end, view=view) }}">{{
            _("Usage Tables") }}</a>

        <a class="slink {{ 'on' if section=='myusage' else '' }}"
            href="{{ url_for('admin.admin_form', section='myusage', before=before, view=view) }}">{{ _("My Usage")
            }}</a>

        <a class="slink {{ 'on' if section=='billing' else '' }}"
            href="{{ url_for('admin.admin_form', section='billing') }}">{{ _("Billing") }}</a>

        <a class="slink {{ 'on' if section=='audit' else '' }}" href="{{ url_for('admin.audit_page') }}">Audit Log</a>
        <a class="slink {{ 'on' if section=='dashboard' else '' }}"
            href="{{ url_for('admin.admin_form', section='dashboard', before=before) }}">
            {{ _("Dashboard") }}
        </a>
        <a class="slink" href="{{ url_for('admin.admin_form', section='tiers') }}">User Tier Overrides</a>
        <!-- <a class="slink" href="{{ url_for('admin.ledger_page') }}">Accounting</a> -->
    </aside>
    <style>
        /* make the three columns line up, bottom-aligned */
.grid2.controls {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: .75rem 1rem;
  align-items: end;  /* bottom-align inputs and buttons */
}

.field { display: flex; flex-direction: column; }
.field > label { margin-bottom: .25rem; }

.actions { display: flex; gap: .5rem; align-self: end; }

    </style>

    <!-- Main -->
    <main>

        {# ================= RATES ================= #}
        {% if section == 'rates' %}
        <div class="card">
            <h3>{{ _("Change Rate") }}</h3>
            <form method="post" action="{{ url_for('admin.admin_update') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label>Tier</label>
                <select id="tierSelect" name="type">
                    <option value="mu" {{ 'selected' if tier=='mu' else '' }}>mu</option>
                    <option value="gov" {{ 'selected' if tier=='gov' else '' }}>gov</option>
                    <option value="private" {{ 'selected' if tier=='private' else '' }}>private</option>
                </select>
                
                <script>
                    (function () {
                        const sel = document.getElementById('tierSelect');
                        const baseUrl = "{{ url_for('admin.admin_form', section='rates') }}";
                        sel.addEventListener('change', (e) => {
                            const u = new URL(baseUrl, window.location.origin);
                            u.searchParams.set('type', e.target.value);
                            // preserve other params if you like:
                            // u.searchParams.set('section', 'rates');
                            window.location.assign(u.toString());
                        });
                    })();
                </script>

                <div class="row">
                    <div>
                        <label>CPU (‡∏ø/cpu-hour)
                            <input type="number" step="0.01" min="0" name="cpu"
                                value="{{ '%.2f'|format(current['cpu']) }}">
                        </label>
                    </div>
                    <div>
                        <label>GPU (‡∏ø/gpu-hour)
                            <input type="number" step="0.01" min="0" name="gpu"
                                value="{{ '%.2f'|format(current['gpu']) }}">
                        </label>
                    </div>
                </div>

                <label>MEM (‡∏ø/GB-hour)
                    <input type="number" step="0.01" min="0" name="mem" value="{{ '%.2f'|format(current['mem']) }}">
                </label>

                <div class="muted">
                    <span class="chip">Selected: {{ tier|upper }}</span>
                    <span class="chip">CPU: ‡∏ø{{ '%.2f'|format(current['cpu']) }}</span>
                    <span class="chip">GPU: ‡∏ø{{ '%.2f'|format(current['gpu']) }}</span>
                    <span class="chip">MEM: ‡∏ø{{ '%.2f'|format(current['mem']) }}</span>
                </div>
<br>
                <button type="submit">Update</button>
            </form>
        </div>

        <div class="card">
            <h3>{{ _("Current Rates (All Tiers)") }}</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>CPU</th>
                        <th>GPU</th>
                        <th>MEM</th>
                    </tr>
                </thead>
                <tbody>
                    {% for name in tiers %}
                    {% set r = all_rates.get(name, {'cpu':0,'gpu':0,'mem':0}) %}
                    <tr class="{{ 'active' if name==tier else '' }}">
                        <td class="tier">{{ name|upper }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['cpu']) }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['gpu']) }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['mem']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# ================= ALL-USERS USAGE ================= #}
        {% elif section == 'usage' %}
        <div class="card">
            <h3>{{ _("Usage Preview")}} (slurmrestd ‚Üí sacct ‚Üí test.csv)</h3>

<form method="get" autocomplete="off" id="usage-form">
    <div class="grid2 controls">
        <!-- Col 1: date -->
        <div class="field">
            <label for="before">Jobs completed before</label>
            <input id="before" type="date" name="before" value="{{ before }}">
        </div>

        <!-- Col 2: user filter (NO nested form) -->
        <div class="field">
            <label for="q-inp">Filter by user</label>
            <small id="q-counter" class="muted" style="display:block;margin-top:.25rem"></small>
            <input id="q-inp" name="q" type="search" value="{{ q or '' }}" placeholder="Start typing a username"
                list="userlist" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
                data-1p-ignore="true" data-lpignore="true">
            <datalist id="userlist">
                {% for u in all_users %}
                <option value="{{ u }}"></option>
                {% endfor %}
            </datalist>
        </div>

        <!-- Col 3: actions (NO label wrapper) -->
        <div class="actions">
            <button type="submit">Fetch Usage</button>
            <button type="button" id="reset-q" class="btn-secondary">Reset Search</button>
        </div>
    </div>

    <input type="hidden" name="section" value="usage">
    <input type="hidden" name="type" value="{{ tier }}">
</form>


            <div class="right muted">
                Source: <b>{{ data_source or '‚Äî' }}</b>{% if notes and notes|length>0 %} ‚Äî {{ notes|join(' | ') }}{%
                endif %}
            </div>
            <div class="clear"></div>

<style>
    /* Priority styles for header legend + raw-table header emphasis
     - primary:      bold + underline + italic
     - 1st fallback: bold + underline
     - 2nd fallback: bold + italic
  */
    .hl-primary {
        font-weight: 700;
        text-decoration: underline;
        font-style: italic;
    }

    .hl-fallback1 {
        font-weight: 700;
        text-decoration: underline;
    }

    .hl-fallback2 {
        font-weight: 700;
        font-style: italic;
    }

    .formula small {
        color: var(--muted, #666);
    }

    details.raw {
        margin-top: .75rem;
    }

    /* The wrapper is the scroll container (vertical + horizontal).
     Sticky headers will pin to the top INSIDE this element. */
    .table-wrap {
        position: relative;
        max-height: 60vh;
        /* vertical scroll */
        overflow: auto;
        /* both axes if needed */
        border: 1px solid var(--bd);
        border-radius: 10px;
    }

    /* Tables inside the wrapper behave like normal tables */
    .table-wrap>table {
        width: 100%;
        border: 0;
        /* wrapper holds the border */
        border-collapse: separate;
        border-spacing: 0;
        margin: 0;
    }

    /* Make header cells sticky within the scroll container */
    .table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        /* keep above body cells */
        background: #f8fafc;
        /* must have a background for sticky */
        box-shadow: 0 1px 0 var(--bd);
        /* subtle divider under the header */
    }

    /* Optional: freeze first column too (uncomment if you want this)
  .table-wrap tbody td:first-child,
  .table-wrap thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 1;
    background: #ffffff;
    box-shadow: 1px 0 0 var(--bd);
  }
  .table-wrap thead th:first-child { z-index: 3; }  /* above the sticky row */
    */

    /* Don‚Äôt let long tokens blow up columns */
    .table-wrap th,
    .table-wrap td {
        overflow-wrap: anywhere;
    }

    .chip {
        display: inline-block;
        padding: .1rem .4rem;
        border-radius: .6rem;
        background: #efefef;
        margin-right: .25rem;
    }

    /* Footnotes / tooltips */
.formula abbr { text-decoration: none; border-bottom: 1px dotted var(--bd); cursor: help; }
.fn { font-size: .8em; margin-left: .25rem; color: var(--muted); text-decoration: none; }
details.footnotes { margin-top: .5rem; }
details.footnotes summary { cursor: pointer; color: #374151; font-weight: 600; }
.fn-list { margin: .25rem 0 0 1.25rem; }
.fn-list li { margin: .25rem 0; }
.fn-var { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

</style>


<!-- Formula legend with matching styles + tooltips + footnotes -->
<div class="formula" style="margin:.5rem 0 .25rem 0">
    <div>
        <b>CPU</b>:
        <span class="hl-primary">
            <abbr
                title="Total CPU time consumed per step (HH:MM:SS). We sum across all steps of the job and convert to hours.">Œ£
                TotalCPU (steps)</abbr>
            <a href="#fn-totalcpu" class="fn">[1]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback1">
            <abbr title="CPU time in seconds (integer). Divide by 3600 to get hours.">CPUTimeRAW / 3600</abbr>
            <a href="#fn-cputimeraw" class="fn">[2]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Allocated CPU cores from TRES √ó wall-clock runtime (hours).">AllocCPUS √ó Elapsed</abbr>
            <a href="#fn-alloccpus" class="fn">[3]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>

    <div>
        <b>MEM</b>:
        <span class="hl-primary">
            <abbr
                title="Average resident set size per step (converted to GB) √ó the step‚Äôs wall-clock hours, summed over steps.">Œ£
                AveRSS(GB) √ó Elapsed (steps)</abbr>
            <a href="#fn-averss" class="fn">[5]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Memory allocated (GB) parsed from TRES mem= √ó wall-clock hours.">Mem_from_TRES √ó Elapsed</abbr>
            <a href="#fn-memfromtres" class="fn">[6]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>

    <div>
        <b>GPU</b>:
        <span class="hl-primary">
            <abbr title="Number of GPUs allocated (from AllocTRES) √ó wall-clock hours.">AllocGPU √ó Elapsed</abbr>
            <a href="#fn-allocgpu" class="fn">[7]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Requested GPUs (from ReqTRES) √ó wall-clock hours (fallback if AllocTRES lacks GPU).">ReqGPU √ó
                Elapsed</abbr>
            <a href="#fn-reqgpu" class="fn">[8]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>
</div>

<!-- Footnotes / glossary -->
<details class="footnotes">
    <summary>What do these variables mean?</summary>
    <ol class="fn-list">
        <li id="fn-totalcpu"><span class="fn-var">TotalCPU</span> ‚Äî Slurm field of CPU time used (HH:MM:SS[.fff]) per
            job/step. We sum over steps and convert to core-hours.</li>
        <li id="fn-cputimeraw"><span class="fn-var">CPUTimeRAW</span> ‚Äî Slurm field of CPU time in seconds (integer). We
            divide by 3600 to get hours; used when <span class="fn-var">TotalCPU</span> is missing/zero.</li>
        <li id="fn-alloccpus"><span class="fn-var">AllocCPUS</span> ‚Äî CPU cores allocated, parsed from <span
                class="fn-var">AllocTRES</span> (fallback <span class="fn-var">ReqTRES</span>) via <span
                class="fn-var">cpu=</span>.</li>
        <li id="fn-elapsed"><span class="fn-var">Elapsed</span> ‚Äî Wall-clock runtime of the parent job (D-HH:MM:SS),
            converted to hours for calculations.</li>
        <li id="fn-averss"><span class="fn-var">AveRSS</span> ‚Äî Average resident set size per step (K/M/G/T). We convert
            to GB; used to estimate memory actually used over time.</li>
        <li id="fn-memfromtres"><span class="fn-var">Mem_from_TRES</span> ‚Äî Memory allocated (GB) parsed from <span
                class="fn-var">AllocTRES</span> (fallback <span class="fn-var">ReqTRES</span>) via <span
                class="fn-var">mem=</span>.</li>
        <li id="fn-allocgpu"><span class="fn-var">AllocGPU</span> ‚Äî GPUs allocated parsed from <span
                class="fn-var">AllocTRES</span> via <span class="fn-var">gres/gpu=</span>.</li>
        <li id="fn-reqgpu"><span class="fn-var">ReqGPU</span> ‚Äî GPUs requested parsed from <span
                class="fn-var">ReqTRES</span> via <span class="fn-var">gres/gpu=</span> (fallback only).</li>
    </ol>
    <div class="muted" style="margin-top:.25rem">
        Notes: ‚Äústeps‚Äù means rows like <span class="fn-var">.batch</span>, <span class="fn-var">.0</span>, etc., which
        roll up to their parent job ID (or array task ID like <span class="fn-var">12345_17</span>). GPU is billed on
        allocation for now; memory prefers used (from <span class="fn-var">AveRSS</span>) and falls back to allocated.
    </div>
</details>


            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}" href="{{ q
                     and url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail', q=q)
                     or  url_for('admin.admin_form', section='usage', before=before, type=tier, view='detail') }}">
                    Detailed
                </a>
                <a class="{{ 'on' if view=='aggregate' else '' }}" href="{{ q
                     and url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate', q=q)
                     or  url_for('admin.admin_form', section='usage', before=before, type=tier, view='aggregate') }}">
                    Aggregate
                </a>
            </div>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <div class="table-wrap" id="usage-detail-wrap">
                <table id="usage-detail">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>JobID</th>
                            <th>Elapsed</th>
                            <th>End</th>
                            <th>State</th>
                            <th>CPU core-hrs</th>
                            <th>GPU (count)</th>
                            <th>GPU hrs</th>
                            <th>Mem (GB alloc)</th>
                            <th>Mem GB-hrs <small>(used)</small></th>
                            <th>Mem GB-hrs <small>(alloc)</small></th>
                            <th>Tier</th>
                            <th>Cost (‡∏ø)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr>
                            <td>{{ r['User'] }}</td>
                            <td>{{ r['JobID'] }}</td>
                            <td>{{ r['Elapsed'] }}</td>
                            <td>{{ r['End']|dt_local }}</td>
                            <td>{{ r['State'] }}</td>
                            <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                            <td>{{ r['GPU_Count'] }}</td>
                            <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                            <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                            <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                            <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                            <td>{{ r['tier']|upper }}</td>
                            <td>‡∏ø{{ '%.2f'|format(r['Cost (‡∏ø)']) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs (used): {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}

            <!-- Collapsible: Raw fetched data (all columns) with styled headers -->
            <details class="raw">
                <summary>Show raw fetched data (parents + steps)</summary>
                {% if raw_cols and raw_rows %}
                <div class="table-wrap">
                    <table id="usage-raw">
                        <thead>
                            <tr>
                                {% for c in raw_cols %}
                                <th class="{{ header_classes.get(c,'') }}">{{ c }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in raw_rows %}
                            <tr>
                                {% for c in raw_cols %}
                                <td>{{ r.get(c) }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="muted" style="margin-top:.25rem">Showing first {{ raw_rows|length }} row(s).</p>
                {% else %}
                <p class="muted">No raw rows.</p>
                {% endif %}
            </details>

            {% else %}
            {% if agg_rows and agg_rows|length>0 %}
            <p class="muted"><span class="chip">Grand total: ‡∏ø{{ '%.2f'|format(grand_total) }}</span></p>
            <table id="usage-agg">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs (used)</th>
                        <th>Total Cost (‡∏ø)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['User'] }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['Cost (‡∏ø)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="muted" style="margin-top:.5rem">
                <span class="chip">CPU core-hrs: {{ '%.2f'|format(tot_cpu) }}</span>
                <span class="chip">GPU hrs: {{ '%.2f'|format(tot_gpu) }}</span>
                <span class="chip">Mem GB-hrs (used): {{ '%.2f'|format(tot_mem) }}</span>
                <span class="chip">Elapsed hrs: {{ '%.2f'|format(tot_elapsed) }}</span>
            </div>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}
        </div>

        {# ================= ADMIN'S OWN USAGE ================= #}
        {% elif section == 'myusage' %}
        <div class="card">
            <h3>{{ _("Usage Preview") }}</h3>

            <form method="get">
                <div class="grid2">
                    <div>
                        <label>Jobs completed before
                            <input type="date" name="before" value="{{ before }}">
                        </label>
                    </div>
                    <div><label>&nbsp;<button type="submit">Fetch</button></label></div>
                </div>
                <input type="hidden" name="section" value="myusage">
            </form>

            <div class="tabs">
                <a class="{{ 'on' if view=='detail' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='detail') }}">{{
                    _("Detailed") }}</a>
                <a class="{{ 'on' if view=='aggregate' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='aggregate') }}">{{
                    _("Aggregate") }}</a>
                <a class="{{ 'on' if view=='billed' else '' }}"
                    href="{{ url_for('admin.admin_form', section='myusage', before=before, view='billed') }}">{{
                    _("Billed") }}</a>
            </div>

            {% if view in ['detail','aggregate'] %}
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>{{ _("Your Jobs") }}</h3>
                <div>
                    <a href="{{ url_for('admin.my_usage_csv_admin', before=before) }}"><button type="button">Download
                            CSV</button></a>
                </div>
            </div>

            <form method="post" action="{{ url_for('admin.create_self_receipt') }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="before" value="{{ before }}">
                <button type="submit">{{ _("Create Receipt") }}</button>
            </form>

            {% if view == 'detail' %}
            {% if rows and rows|length>0 %}
            <p class="muted">
                <span class="chip">Jobs: {{ rows|length }}</span>
                <span class="chip">Total: ‡∏ø{{ '%.2f'|format(grand_total) }}</span>
            </p>
            <table>
                <thead>
                    <tr>
                        <th>JobID</th>
                        <th>Elapsed</th>
                        <th>End</th>
                        <th>State</th>
                        <th>CPU core-hrs</th>
                        <th>GPU (count)</th>
                        <th>GPU hrs</th>
                        <th>Mem (GB alloc)</th>
                        <th>Mem GB-hrs <small>(used)</small></th>
                        <th>Mem GB-hrs <small>(alloc)</small></th>
                        <th>Tier</th>
                        <th>Cost (‡∏ø)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr>
                        <td>{{ r['JobID'] }}</td>
                        <td>{{ r['Elapsed'] }}</td>
                        <td>{{ r['End']|dt_local }}</td>
                        <td>{{ r['State'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ r['GPU_Count'] }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                        <td>{{ r['tier']|upper }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['Cost (‡∏ø)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% else %} {# aggregate #}
            {% if agg_rows and agg_rows|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Jobs</th>
                        <th>CPU core-hrs</th>
                        <th>GPU hrs</th>
                        <th>Mem GB-hrs (used)</th>
                        <th>Total Cost (‡∏ø)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in agg_rows %}
                    <tr>
                        <td>{{ r['tier']|upper }}</td>
                        <td>{{ r['jobs'] }}</td>
                        <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                        <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['Cost (‡∏ø)']) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No rows for the given range.</p>
            {% endif %}
            {% endif %}

            {% else %} {# view == 'billed' #}
            <h4>Pending (unpaid) receipts</h4>
            {% if my_pending_receipts and my_pending_receipts|length>0 %}
            <p class="muted"><span class="chip">Total: ‡∏ø{{ '%.2f'|format(sum_pending) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Period</th>
                        <th>Total (‡∏ø)</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in my_pending_receipts %}
                    <tr>
                        <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                        <td>{{ r['start'] }} ‚Üí {{ r['end'] }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['created_at']|dt_local }}</td>
                        <td>
                            <form method="get" action="{{ url_for('payments.start_receipt_payment', rid=r['id']) }}"
                                style="display:inline">
                                <button type="submit">Pay now</button>
                            </form>

                            <form method="post" action="{{ url_for('admin.mark_paid', rid=r['id']) }}"
                                style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit">{{ _("Mark as paid") }}</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">Nothing pending üéâ</p>
            {% endif %}

            <h4 style="margin-top:1rem">Paid receipts</h4>
            {% if my_paid_receipts and my_paid_receipts|length>0 %}
            <p class="muted"><span class="chip">Total: ‡∏ø{{ '%.2f'|format(sum_paid) }}</span></p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Period</th>
                        <th>Total (‡∏ø)</th>
                        <th>Paid at</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in my_paid_receipts %}
                    <tr>
                        <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                        <td>{{ r['start'] }} ‚Üí {{ r['end'] }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['paid_at']|dt_local or '‚Äî' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No paid receipts yet.</p>
            {% endif %}
            {% endif %}
        </div>

        {# ================= BILLING (ALL USERS) ================= #}
        {% elif section == 'billing' %}
        <div class="card">
            <h3>{{ _("Pending Receipts")}}</h3>
            {% if pending and pending|length>0 %}
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>User</th>
            <th>Period</th>
            <th>Total (‡∏ø)</th>
            <th>Created</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for r in pending %}
        <tr>
            <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
            <td>{{ r['username'] }}</td>
            <td>{{ r['start'] }} ‚Üí {{ r['end'] }}</td>
            <td>‡∏ø{{ '%.2f'|format(r['total']) }}</td>
            <td>{{ r['created_at']|dt_local }}</td>
            <td>{{ r['status'] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
            {% else %}
            <p class="muted">Nothing pending üéâ</p>
            {% endif %}
        </div>
        <div class="card" style="margin-top:1rem">
            <h3>Paid Receipts</h3>
            {% if paid and paid|length>0 %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Period</th>
                        <th>Total (‡∏ø)</th>
                        <th>Paid at</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in paid %}
                    <tr>
                        <td><a href="{{ url_for('user.view_receipt', rid=r['id']) }}">#{{ r['id'] }}</a></td>
                        <td>{{ r['username'] }}</td>
                        <td>{{ r['start'] }} ‚Üí {{ r['end'] }}</td>
                        <td>‡∏ø{{ '%.2f'|format(r['total']) }}</td>
                        <td>{{ r['paid_at']|dt_local or '‚Äî' }}</td>
                        <td>{{ r['status'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No paid receipts yet.</p>
            {% endif %}
        </div>


        <div class="card">
            <h3>{{ _("Download Payment History")}}</h3>
            <p class="muted">Exports all <b>paid</b> receipts.</p>
            <a href="{{ url_for('admin.paid_csv') }}"><button type="button">Download paid history (CSV)</button></a>
        </div>

        {% else %}
        <p class="muted">Unknown section.</p>
        {% endif %}

    </main>
</div>
<script>

    function syncTabLinks(q) {
            const tabs = document.querySelectorAll('.tabs a');
            tabs.forEach(a => {
                const url = new URL(a.href, window.location.origin);
                if ((q || '').trim()) {
                    url.searchParams.set('q', q);
                } else {
                    url.searchParams.delete('q');
                }
                a.href = url.toString();
            });
        }

        // call from applyFilter():
        function applyFilter() {
            const q = inp ? inp.value : '';
            filterTableByUser(tblDetail, q);
            filterTableByUser(tblAgg, q);
            filterTableByUser(tblRaw, q);
            updateCounter(q);
            syncTabLinks(q); // <‚Äî add this
        }


    (function () {
        const form = document.getElementById('usage-form');
        const inp = document.getElementById('q-inp');
        const resetBtn = document.getElementById('reset-q');
        const counter = document.getElementById('q-counter');

        // Tables we can filter on the client
        const tblDetail = document.getElementById('usage-detail');
        const tblAgg = document.getElementById('usage-agg');
        const tblRaw = document.getElementById('usage-raw'); // optional: comment out if you don't want to filter raw

        // Utility: debounce
        const debounce = (fn, ms = 150) => {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(null, args), ms);
            };
        };

        // Find the "User" column index in a table (by header text)
        function findUserColIndex(table) {
            if (!table) return -1;
            const ths = table.querySelectorAll('thead th');
            for (let i = 0; i < ths.length; i++) {
                if ((ths[i].textContent || '').trim().toLowerCase() === 'user') return i;
            }
            return -1;
        }

        // Generic filter for a table by "User" column
        function filterTableByUser(table, q) {
            if (!table) return { shown: 0, total: 0 };

            const userCol = findUserColIndex(table);
            if (userCol === -1) {
                // If there's no "User" column (e.g., detail table always has one, agg has one),
                // we skip this table.
                return { shown: 0, total: 0 };
            }
            const rows = table.querySelectorAll('tbody tr');
            const qq = (q || '').trim().toLowerCase();

            let shown = 0;
            rows.forEach(tr => {
                const cells = tr.children;
                const userText = (cells[userCol]?.textContent || '').toLowerCase();
                const match = !qq || userText.includes(qq);
                tr.style.display = match ? '' : 'none';
                if (match) shown++;
            });
            return { shown, total: rows.length };
        }

        // Update the counter text, combining all visible tables on the page
        function updateCounter(q) {
            const parts = [];
            // Only count tables that exist on this view
            const a = filterTableByUser(tblDetail, q);
            const b = filterTableByUser(tblAgg, q);
            const c = filterTableByUser(tblRaw, q);   // comment this out if you don't want to live-filter Raw
            const totals = [a, b, c].filter(x => x.total > 0);

            if (totals.length === 0) {
                counter && (counter.textContent = '');
                return;
            }

            const shown = totals.reduce((s, x) => s + x.shown, 0);
            const total = totals.reduce((s, x) => s + x.total, 0);
            if (!counter) return;

            if ((q || '').trim()) {
                counter.textContent = `Showing ${shown} of ${total} row(s) for ‚Äú${q}‚Äù (local filter)`;
            } else {
                counter.textContent = `Showing all ${total} row(s)`;
            }
        }

        // Live filter on input
        function applyFilter() {
            const q = inp ? inp.value : '';
            // Filter whichever table(s) is/are present on this view
            filterTableByUser(tblDetail, q);
            filterTableByUser(tblAgg, q);
            filterTableByUser(tblRaw, q);   // comment out to skip raw
            updateCounter(q);
        }

        const applyFilterDebounced = debounce(applyFilter, 150);

        // Show datalist on focus (your original helper)
        if (inp) {
            inp.addEventListener('focus', function () {
                if (!this.value) {
                    const v = this.value;
                    this.value = ' ';
                    this.dispatchEvent(new Event('input', { bubbles: true }));
                    setTimeout(() => { this.value = v; }, 10);
                }
            });

            // Real-time filtering while typing
            inp.addEventListener('input', applyFilterDebounced);

            // Optional: if you ALSO want to refresh from server after a pause, uncomment:
            // const submitDebounced = debounce(() => form && form.submit(), 800);
            // inp.addEventListener('input', submitDebounced);
        }

        // Reset search: clear and show everything (no reload)
        if (resetBtn && inp) {
            resetBtn.addEventListener('click', function () {
                inp.value = '';
                applyFilter(); // instantly show all rows

                // Keep URL tidy (remove ?q=...) without reloading
                if (history && history.replaceState) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('q');
                    history.replaceState({}, '', url.toString());
                }
            });
        }

        // Initial counter state on load
        applyFilter();
    })();
</script>



{% endblock %}
