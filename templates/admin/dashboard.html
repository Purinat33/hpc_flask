{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h2>{{ _("Admin Dashboard") }}</h2>
<p class="muted">
    {{ _("Completed before") }}:
    <b>{{ end }}</b> •
    {{ _("Data source") }}: <b>{{ data_source or "unknown" }}</b>
    {% if notes and notes|length %} • <span title="{{ notes|join(' | ') }}">notes</span>{% endif %}
    <div class="toolbar no-print" style="display:flex;justify-content:flex-end;gap:.5rem;">
        <button type="button" onclick="window.print()">Export as PDF</button>
    </div>
</p>

<div class="grid" style="grid-template-columns: repeat(4, minmax(180px,1fr)); gap:1rem;">
    <div class="card">
        <h3>Unbilled Cost</h3>
        <div class="big">฿{{ '%.2f'|format(kpis.unbilled_cost or 0) }}</div>
    </div>
    <div class="card">
        <h3>Pending Receivables</h3>
        <div class="big">฿{{ '%.2f'|format(kpis.pending_receivables or 0) }}</div>
    </div>
    <div class="card">
        <h3>Paid (last 30d)</h3>
        <div class="big">฿{{ '%.2f'|format(kpis.paid_last_30d or 0) }}</div>
    </div>
    <div class="card">
        <h3>Jobs (last 30d)</h3>
        <div class="big">{{ kpis.jobs_last_30d or 0 }}</div>
    </div>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap:1rem; margin-top:1rem;">
    <div class="card">
        <h3>Daily Total Cost (90d)</h3>
        <canvas id="dailyCost"></canvas>
    </div>
    <div class="card">
        <h3>Cost by Tier</h3>
        <canvas id="tierPie"></canvas>
    </div>
</div>

<div class="card" style="margin-top:1rem;">
    <h3>Top 10 Users by Cost</h3>
    <canvas id="topUsers"></canvas>
</div>

<div class="grid" style="grid-template-columns: repeat(3, 1fr); gap:1rem; margin-top:1rem;">
    <div class="card">
        <h3>Top Nodes by Jobs</h3>
        <canvas id="nodesByJobs"></canvas>
    </div>
    <div class="card">
        <h3>Top Nodes by CPU core-hrs</h3>
        <canvas id="nodesByCPU"></canvas>
    </div>
    {% if series.node_gpu_labels|length %}
    <div class="card">
        <h3>Top Nodes by GPU-hrs</h3>
        <canvas id="nodesByGPU"></canvas>
    </div>
    {% endif %}
</div>



<!-- Optional totals chips -->
<div class="muted" style="margin-top:.5rem;">
    Σ CPU core-hrs: {{ '%.2f'|format(tot_cpu) }} •
    Σ GPU hrs: {{ '%.2f'|format(tot_gpu) }} •
    Σ Mem GB-hrs: {{ '%.2f'|format(tot_mem) }}
</div>

<!-- Lightweight charts via CDN -->
<script>
    // define BEFORE any Chart(...) calls
    const PRINT_MODE = !!(window.matchMedia && window.matchMedia('print').matches);
    window.dashboardCharts = window.dashboardCharts || [];
</script>

<script>
    function safeChart(id, cfg) {
        try {
            const el = document.getElementById(id);
            if (!el) return;
            const c = new Chart(el, cfg);
            (window.dashboardCharts ||= []).push(c);
        } catch (e) { console.error("chart failed:", id, e); }
    }
    // then call safeChart('dailyCost', {...}), etc.
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
    const dailyLabels = {{ series.daily_labels| tojson }};
    const dailyData = {{ series.daily_cost| tojson }};
    const tierLabels = {{ series.tier_labels| tojson }};
    const tierValues = {{ series.tier_values| tojson }};
    const userLabels = {{ series.top_users_labels| tojson }};
    const userValues = {{ series.top_users_values| tojson }};

    // NEW node series
    const nodeJobsLabels = {{ series.node_jobs_labels| tojson }};
    const nodeJobsValues = {{ series.node_jobs_values| tojson }};
    const nodeCPULabels = {{ series.node_cpu_labels| tojson }};
    const nodeCPUValues = {{ series.node_cpu_values| tojson }};
    const nodeGPULabels = {{ series.node_gpu_labels| tojson }};
    const nodeGPUValues = {{ series.node_gpu_values| tojson }};

    // keep a global list so we can re-render before print
    window.dashboardCharts = window.dashboardCharts || [];

    window.dashboardCharts.push(new Chart(document.getElementById('dailyCost'), {
        type: 'line',
        data: { labels: dailyLabels, datasets: [{ label: 'Cost (฿)', data: dailyData, tension: .25, fill: false }] },
        options: {
            animation: !PRINT_MODE, plugins: { legend: { display: false } },
            scales: { x: { ticks: { maxTicksLimit: 8 } }, y: { beginAtZero: true } }
        }
    }));

    window.dashboardCharts.push(new Chart(document.getElementById('tierPie'), {
        type: 'pie',
        data: { labels: tierLabels, datasets: [{ data: tierValues }] },
        options: { animation: !PRINT_MODE, plugins: { legend: { position: 'bottom' } } }
    }));

    window.dashboardCharts.push(new Chart(document.getElementById('topUsers'), {
        type: 'bar',
        data: { labels: userLabels, datasets: [{ label: 'Cost (฿)', data: userValues }] },
        options: {
            animation: !PRINT_MODE, plugins: { legend: { display: false } },
            indexAxis: 'y', scales: { x: { beginAtZero: true } }
        }
    }));

    // --- NEW node charts (create only if have data) ---
    if (nodeJobsLabels.length) {
        window.dashboardCharts.push(new Chart(document.getElementById('nodesByJobs'), {
            type: 'bar',
            data: { labels: nodeJobsLabels, datasets: [{ label: 'Jobs', data: nodeJobsValues }] },
            options: {
                animation: !PRINT_MODE, plugins: { legend: { display: false } },
                indexAxis: 'y', scales: { x: { beginAtZero: true, precision: 0 } }
            }
        }));
    }

    if (nodeCPULabels.length) {
        window.dashboardCharts.push(new Chart(document.getElementById('nodesByCPU'), {
            type: 'bar',
            data: { labels: nodeCPULabels, datasets: [{ label: 'CPU core-hrs', data: nodeCPUValues }] },
            options: {
                animation: !PRINT_MODE, plugins: { legend: { display: false } },
                indexAxis: 'y', scales: { x: { beginAtZero: true } }
            }
        }));
    }

    if (nodeGPULabels.length) {
        window.dashboardCharts.push(new Chart(document.getElementById('nodesByGPU'), {
            type: 'bar',
            data: { labels: nodeGPULabels, datasets: [{ label: 'GPU-hrs', data: nodeGPUValues }] },
            options: {
                animation: !PRINT_MODE, plugins: { legend: { display: false } },
                indexAxis: 'y', scales: { x: { beginAtZero: true } }
            }
        }));
    }
</script>

<script>
    // If you create charts dynamically, flag “print mode” to disable animations.
    const PRINT_MODE = window.matchMedia && window.matchMedia('print').matches;
    // Example: when constructing charts, pass { animation: !PRINT_MODE } in options.

    // Also re-render just before print (covers browsers that evaluate after layout)
    window.addEventListener('beforeprint', () => {
        if (window.dashboardCharts && Array.isArray(window.dashboardCharts)) {
            for (const ch of window.dashboardCharts) { try { ch.update('none'); } catch (e) { } }
        }
    });
</script>

<style>
    @media print {
        @page {
            size: A4 portrait;
            margin: 10mm;
        }

        /* Hide chrome/nav/buttons when printing */
        .no-print,
        nav,
        .sidebar,
        .tabs,
        .slink,
        .btn,
        .toolbar {
            display: none !important;
        }

        /* Make the main column full-width */
        .layout {
            display: block !important;
        }

        /* Let tables fully expand when printing */
        .table-wrap {
            max-height: none !important;
            overflow: visible !important;
            border: 0;
        }

        /* Avoid breaking cards mid-page */
        .card {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* Don’t append URLs after links */
        a[href]:after {
            content: "";
        }
    }
</style>


{% endblock %}
