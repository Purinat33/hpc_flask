<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>General Ledger ({{ 'Preview' if is_preview else 'Posted' }})</title>
    <style>
      @page {
        size: A4;
        margin: 18mm 14mm 18mm 14mm;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }

      /* Watermark: big, faint, diagonal */
      .wm {
        position: fixed;
        top: 30%;
        left: -10%;
        right: -10%;
        transform: rotate(-30deg);
        text-align: center;
        font-size: 90px;
        letter-spacing: 6px;
        color: rgba(200, 0, 0, 0.08);
        z-index: 0;
      }

      .page {
        page-break-after: always;
        position: relative;
        z-index: 1;
      }
      .header,
      .footer {
        font-size: 10.5px;
        color: #555;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        border-bottom: 1px solid #ddd;
        padding-bottom: 6px;
        margin-bottom: 8px;
      }
      .h-left {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 10px;
        border: 1px solid #ddd;
      }
      .pill.posted {
        background: #e8f6ee;
        border-color: #c9efcf;
        color: #0a5;
      }
      .pill.preview {
        background: #fff5d6;
        border-color: #ffe3a3;
        color: #8a5a00;
      }

      .meta {
        display: flex;
        gap: 14px;
      }
      .meta b {
        font-weight: 700;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      thead th {
        text-align: left;
        border-bottom: 1px solid #ccc;
        padding: 6px 4px;
        background: #fafafa;
      }
      tbody td {
        border-bottom: 1px solid #eee;
        padding: 5px 4px;
        vertical-align: top;
      }
      td.num,
      th.num {
        text-align: right;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #ddd;
        padding-top: 6px;
        margin-top: 8px;
      }
      .muted {
        color: #777;
      }

      /* Make sure each chunk fits: keep rows tidy */
      .row {
        line-height: 1.25;
      }
    </style>
  </head>
  <body>
    <div class="wm">{{ watermark_text }}</div>

    {% if total_pages == 0 %}
    <div class="page">
      <div class="header">
        <div class="h-left">
          <div class="pill {{ 'preview' if is_preview else 'posted' }}">
            {{ 'Mode: Preview (derived)' if is_preview else 'Mode: Posted
            (authoritative)' }}
          </div>
          <div>General Ledger</div>
        </div>
        <div class="meta">
          <div><b>Window</b> {{ start }} → {{ end }}</div>
          <div><b>Run</b> {{ run_id }}</div>
          <div><b>Doc SHA256</b> {{ doc_digest_short }}…</div>
        </div>
      </div>
      <p class="muted">No lines in this window.</p>
    </div>
    {% endif %} {% for p in pages %}
    <div class="page">
      <div class="header">
        <div class="h-left">
          <div class="pill {{ 'preview' if is_preview else 'posted' }}">
            {{ 'Mode: Preview (derived)' if is_preview else 'Mode: Posted
            (authoritative)' }}
          </div>
          <div><b>General Ledger</b></div>
        </div>
        <div class="meta">
          <div><b>Window</b> {{ start }} → {{ end }}</div>
          <div><b>Run</b> {{ run_id }}</div>
          <div><b>Doc SHA256</b> {{ doc_digest_short }}…</div>
          <div><b>Page Hash</b> {{ p.hash }}</div>
          <div><b>Page</b> {{ p.index }} / {{ total_pages }}</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 12%">Date</th>
            <th style="width: 11%">Ref</th>
            <th>Memo</th>
            <th style="width: 22%">Account</th>
            <th style="width: 10%" class="num">Dr</th>
            <th style="width: 10%" class="num">Cr</th>
          </tr>
        </thead>
        <tbody>
          {% for r in p.rows %}
          <tr class="row">
            <td>{{ r.date }}</td>
            <td>{{ r.ref }}</td>
            <td>{{ r.memo }}</td>
            <td>{{ r.account_id }} — {{ r.account_name }}</td>
            <td class="num">{{ '%.2f'|format(r.debit or 0) }}</td>
            <td class="num">{{ '%.2f'|format(r.credit or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="footer">
        <div class="muted">
          Printed {{ printed_on.astimezone().strftime('%Y-%m-%d %H:%M:%S %Z') }}
          by {{ printed_by }} • First/Last Ref on page: {{ p.first_ref }} → {{
          p.last_ref }}
        </div>
        <div class="muted">Run {{ run_id }} • Doc SHA256 {{ doc_digest }}</div>
      </div>
    </div>
    {% endfor %}
  </body>
</html>
