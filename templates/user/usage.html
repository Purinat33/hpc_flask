{% extends "base.html" %}
{% block title %}My Usage{% endblock %}

{% block content %}
<h2>{{_("My Usage")}}</h2>
<p class="muted">{% trans user=current_user.username %}Signed in as <b>{{ user }}</b>{% endtrans %}</p>

<div class="card">
    <h3>Filter</h3>
    <form method="get" class="grid">
        <div>
            <label>Jobs completed before
                <input type="date" name="before" value="{{ before }}">
            </label>
        </div>
        <div><label>&nbsp;<button type="submit">Fetch</button></label></div>
    </form>

    {% if data_source %}
    <p class="muted">Source: <b>{{ data_source }}</b>{% if notes and notes|length>0 %} — {{ notes|join(' | ') }}{% endif
        %}</p>
    {% endif %}
</div>

<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>Your Jobs</h3>
        <div>
            <a href="{{ url_for('user.my_usage_csv', before=before) }}"><button type="button">Download CSV</button></a>
        </div>
    </div>

    <form method="post" action="{{ url_for('user.create_receipt') }}" style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="before" value="{{ before }}">
        <button type="submit">Create Receipt</button>
    </form>


    <div class="tabs">
        <a class="{{ 'on' if view=='detail' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='detail') }}">Detailed</a>
        <a class="{{ 'on' if view=='aggregate' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='aggregate') }}">Aggregate</a>
        <a class="{{ 'on' if view=='billed' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='billed') }}">Billed</a>
    </div>


    {% if view == 'detail' %}
    {% if rows and rows|length>0 %}
    <p class="muted">
        <span class="chip">Jobs: {{ rows|length }}</span>
        <span class="chip">Total cost: ฿{{ '%.2f'|format(total_cost) }}</span>
    </p>
    <table>
        <thead>
            <tr>
                <th>JobID</th>
                <th>Elapsed</th>
                <th>TotalCPU</th>
                <th>ReqTRES</th>

                <th>CPU core-hrs</th>
                <th>GPU hrs</th>
                <th>Mem GB-hrs</th>
                <th>State</th>
                <th>Tier</th>
                <th>Cost (฿)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r['JobID'] }}</td>
                <td>{{ r['Elapsed'] }}</td>
                <td>{{ r['TotalCPU'] }}</td>
                <td>{{ r['ReqTRES'] }}</td>
                <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                <td>{{ r['State'] }}</td>
                <td>{{ r['tier']|upper }}</td>
                <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No jobs for the selected period.</p>
    {% endif %}

    {% elif view == 'aggregate' %}
    {% if agg_rows and agg_rows|length>0 %}
    <table>
        <thead>
            <tr>
                <th>Jobs</th>
                <th>CPU core-hrs</th>
                <th>GPU hrs</th>
                <th>Mem GB-hrs</th>
                <th>Total Cost (฿)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in agg_rows %}
            <tr>
                <td>{{ r['jobs'] }}</td>
                <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['Mem_GB_Hours']) }}</td>
                <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No jobs for the selected period.</p>
    {% endif %}

    {% elif view == 'billed' %}
    <h4>Pending (unpaid) jobs</h4>
    {% if pending and pending|length>0 %}
    <p class="muted">
        <span class="chip">Jobs: {{ pending|length }}</span>
        <span class="chip">Total: ฿{{ '%.2f'|format(sum_pending) }}</span>
    </p>
    <table>
        <thead>
            <tr>
                <th>Receipt</th>
                <th>Period</th>
                <th>Job</th>
                <th>CPU hrs</th>
                <th>GPU hrs</th>
                <th>Mem GB-hrs</th>
                <th>Cost (฿)</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for it in pending %}
            <tr>
                <td><a href="{{ url_for('user.view_receipt', rid=it['receipt_id']) }}">#{{ it['receipt_id'] }}</a></td>
                <td>{{ it['start'] }} → {{ it['end'] }}</td>
                <td>{{ it['job_id_display'] }}</td>
                <td>{{ '%.2f'|format(it['cpu_core_hours']) }}</td>
                <td>{{ '%.2f'|format(it['gpu_hours']) }}</td>
                <td>{{ '%.2f'|format(it['mem_gb_hours']) }}</td>
                <td>฿{{ '%.2f'|format(it['cost']) }}</td>
                <td>{{ it['created_at'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No pending jobs.</p>
    {% endif %}

    <h4 style="margin-top:1rem">Paid jobs</h4>
    {% if paid and paid|length>0 %}
    <p class="muted">
        <span class="chip">Jobs: {{ paid|length }}</span>
        <span class="chip">Total: ฿{{ '%.2f'|format(sum_paid) }}</span>
    </p>
    <table>
        <thead>
            <tr>
                <th>Receipt</th>
                <th>Period</th>
                <th>Job</th>
                <th>CPU hrs</th>
                <th>GPU hrs</th>
                <th>Mem GB-hrs</th>
                <th>Cost (฿)</th>
                <th>Paid at</th>
            </tr>
        </thead>
        <tbody>
            {% for it in paid %}
            <tr>
                <td><a href="{{ url_for('user.view_receipt', rid=it['receipt_id']) }}">#{{ it['receipt_id'] }}</a></td>
                <td>{{ it['start'] }} → {{ it['end'] }}</td>
                <td>{{ it['job_id_display'] }}</td>
                <td>{{ '%.2f'|format(it['cpu_core_hours']) }}</td>
                <td>{{ '%.2f'|format(it['gpu_hours']) }}</td>
                <td>{{ '%.2f'|format(it['mem_gb_hours']) }}</td>
                <td>฿{{ '%.2f'|format(it['cost']) }}</td>
                <td>{{ it['paid_at'] or '—' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No paid jobs yet.</p>
    {% endif %}

    {% else %}
    <p class="muted">Unknown view.</p>
    {% endif %}
</div>
{% endblock %}
