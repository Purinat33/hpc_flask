{% extends "base.html" %}
{% block title %}My Usage{% endblock %}

{% block content %}
<h2>{{_("My Usage")}}</h2>
<p class="muted">{% trans user=current_user.username %}Signed in as <b>{{ user }}</b>{% endtrans %}</p>

<div class="card">
    <h3>Filter</h3>
    <form method="get" class="grid">
        <div>
            <label>Jobs completed before
                <input type="date" name="before" value="{{ before }}">
            </label>
        </div>
        <div><label>&nbsp;<button type="submit">Fetch</button></label></div>
    </form>

    {% if data_source %}
    <p class="muted">Source: <b>{{ data_source }}</b>{% if notes and notes|length>0 %} — {{ notes|join(' | ') }}{% endif
        %}</p>
    {% endif %}
</div>

<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>Your Jobs</h3>
        <div>
            <a href="{{ url_for('user.my_usage_csv', before=before) }}"><button type="button">Download CSV</button></a>
        </div>
    </div>

    <form method="post" action="{{ url_for('user.create_receipt') }}" style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="before" value="{{ before }}">
        <button type="submit">{{ _("Create Receipt")}}</button>
    </form>

    <div class="tabs">
        <a class="{{ 'on' if view=='detail' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='detail') }}">Detailed</a>
        <a class="{{ 'on' if view=='aggregate' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='aggregate') }}">Aggregate</a>
        <a class="{{ 'on' if view=='billed' else '' }}"
            href="{{ url_for('user.my_usage', before=before, view='billed') }}">Billed</a>
    </div>

<style>
    /* Priority styles for header legend + raw-table header emphasis
     - primary:      bold + underline + italic
     - 1st fallback: bold + underline
     - 2nd fallback: bold + italic
  */
    .hl-primary {
        font-weight: 700;
        text-decoration: underline;
        font-style: italic;
    }

    .hl-fallback1 {
        font-weight: 700;
        text-decoration: underline;
    }

    .hl-fallback2 {
        font-weight: 700;
        font-style: italic;
    }

    .formula small {
        color: var(--muted, #666);
    }

    details.raw {
        margin-top: .75rem;
    }

    /* The wrapper is the scroll container (vertical + horizontal).
     Sticky headers will pin to the top INSIDE this element. */
    .table-wrap {
        position: relative;
        max-height: 60vh;
        /* vertical scroll */
        overflow: auto;
        /* both axes if needed */
        border: 1px solid var(--bd);
        border-radius: 10px;
    }

    /* Tables inside the wrapper behave like normal tables */
    .table-wrap>table {
        width: 100%;
        border: 0;
        /* wrapper holds the border */
        border-collapse: separate;
        border-spacing: 0;
        margin: 0;
    }

    /* Make header cells sticky within the scroll container */
    .table-wrap thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        /* keep above body cells */
        background: #f8fafc;
        /* must have a background for sticky */
        box-shadow: 0 1px 0 var(--bd);
        /* subtle divider under the header */
    }

    /* Optional: freeze first column too (uncomment if you want this)
  .table-wrap tbody td:first-child,
  .table-wrap thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 1;
    background: #ffffff;
    box-shadow: 1px 0 0 var(--bd);
  }
  .table-wrap thead th:first-child { z-index: 3; }  /* above the sticky row */
    */

    /* Don’t let long tokens blow up columns */
    .table-wrap th,
    .table-wrap td {
        overflow-wrap: anywhere;
    }

    .chip {
        display: inline-block;
        padding: .1rem .4rem;
        border-radius: .6rem;
        background: #efefef;
        margin-right: .25rem;
    }


    /* Footnotes / tooltips */
.formula abbr { text-decoration: none; border-bottom: 1px dotted var(--bd); cursor: help; }
.fn { font-size: .8em; margin-left: .25rem; color: var(--muted); text-decoration: none; }
details.footnotes { margin-top: .5rem; }
details.footnotes summary { cursor: pointer; color: #374151; font-weight: 600; }
.fn-list { margin: .25rem 0 0 1.25rem; }
.fn-list li { margin: .25rem 0; }
.fn-var { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

</style>


    {% if view in ['detail','aggregate'] %}
    {% if data_source %}
    <p class="muted">Source: <b>{{ data_source }}</b>{% if notes and notes|length>0 %} — {{ notes|join(' | ') }}{% endif
        %}</p>
    {% endif %}

<!-- Formula legend with matching styles + tooltips + footnotes -->
<div class="formula" style="margin:.5rem 0 .25rem 0">
    <div>
        <b>CPU</b>:
        <span class="hl-primary">
            <abbr
                title="Total CPU time consumed per step (HH:MM:SS). We sum across all steps of the job and convert to hours.">Σ
                TotalCPU (steps)</abbr>
            <a href="#fn-totalcpu" class="fn">[1]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback1">
            <abbr title="CPU time in seconds (integer). Divide by 3600 to get hours.">CPUTimeRAW / 3600</abbr>
            <a href="#fn-cputimeraw" class="fn">[2]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Allocated CPU cores from TRES × wall-clock runtime (hours).">AllocCPUS × Elapsed</abbr>
            <a href="#fn-alloccpus" class="fn">[3]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>

    <div>
        <b>MEM</b>:
        <span class="hl-primary">
            <abbr
                title="Average resident set size per step (converted to GB) × the step’s wall-clock hours, summed over steps.">Σ
                AveRSS(GB) × Elapsed (steps)</abbr>
            <a href="#fn-averss" class="fn">[5]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Memory allocated (GB) parsed from TRES mem= × wall-clock hours.">Mem_from_TRES × Elapsed</abbr>
            <a href="#fn-memfromtres" class="fn">[6]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>

    <div>
        <b>GPU</b>:
        <span class="hl-primary">
            <abbr title="Number of GPUs allocated (from AllocTRES) × wall-clock hours.">AllocGPU × Elapsed</abbr>
            <a href="#fn-allocgpu" class="fn">[7]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
        <small>or</small>
        <span class="hl-fallback2">
            <abbr title="Requested GPUs (from ReqTRES) × wall-clock hours (fallback if AllocTRES lacks GPU).">ReqGPU ×
                Elapsed</abbr>
            <a href="#fn-reqgpu" class="fn">[8]</a><a href="#fn-elapsed" class="fn">[4]</a>
        </span>
    </div>
</div>

<!-- Footnotes / glossary -->
<details class="footnotes">
    <summary>What do these variables mean?</summary>
    <ol class="fn-list">
        <li id="fn-totalcpu"><span class="fn-var">TotalCPU</span> — Slurm field of CPU time used (HH:MM:SS[.fff]) per
            job/step. We sum over steps and convert to core-hours.</li>
        <li id="fn-cputimeraw"><span class="fn-var">CPUTimeRAW</span> — Slurm field of CPU time in seconds (integer). We
            divide by 3600 to get hours; used when <span class="fn-var">TotalCPU</span> is missing/zero.</li>
        <li id="fn-alloccpus"><span class="fn-var">AllocCPUS</span> — CPU cores allocated, parsed from <span
                class="fn-var">AllocTRES</span> (fallback <span class="fn-var">ReqTRES</span>) via <span
                class="fn-var">cpu=</span>.</li>
        <li id="fn-elapsed"><span class="fn-var">Elapsed</span> — Wall-clock runtime of the parent job (D-HH:MM:SS),
            converted to hours for calculations.</li>
        <li id="fn-averss"><span class="fn-var">AveRSS</span> — Average resident set size per step (K/M/G/T). We convert
            to GB; used to estimate memory actually used over time.</li>
        <li id="fn-memfromtres"><span class="fn-var">Mem_from_TRES</span> — Memory allocated (GB) parsed from <span
                class="fn-var">AllocTRES</span> (fallback <span class="fn-var">ReqTRES</span>) via <span
                class="fn-var">mem=</span>.</li>
        <li id="fn-allocgpu"><span class="fn-var">AllocGPU</span> — GPUs allocated parsed from <span
                class="fn-var">AllocTRES</span> via <span class="fn-var">gres/gpu=</span>.</li>
        <li id="fn-reqgpu"><span class="fn-var">ReqGPU</span> — GPUs requested parsed from <span
                class="fn-var">ReqTRES</span> via <span class="fn-var">gres/gpu=</span> (fallback only).</li>
    </ol>
    <div class="muted" style="margin-top:.25rem">
        Notes: “steps” means rows like <span class="fn-var">.batch</span>, <span class="fn-var">.0</span>, etc., which
        roll up to their parent job ID (or array task ID like <span class="fn-var">12345_17</span>). GPU is billed on
        allocation for now; memory prefers used (from <span class="fn-var">AveRSS</span>) and falls back to allocated.
    </div>
</details>

    {% endif %}

    {% if view == 'detail' %}
    {% if rows and rows|length>0 %}
    <p class="muted">
        <span class="chip">Jobs: {{ rows|length }}</span>
        <span class="chip">Total cost: ฿{{ '%.2f'|format(total_cost) }}</span>
    </p>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>JobID</th>
                    <th>Elapsed</th>
                    <th>End</th>
                    <th>State</th>
                    <th>CPU core-hrs</th>
                    <th>GPU (count)</th>
                    <th>GPU hrs</th>
                    <th>Mem (GB alloc)</th>
                    <th>Mem GB-hrs <small>(used)</small></th>
                    <th>Mem GB-hrs <small>(alloc)</small></th>
                    <th>Tier</th>
                    <th>Cost (฿)</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rows %}
                <tr>
                    <td>{{ r['JobID'] }}</td>
                    <td>{{ r['Elapsed'] }}</td>
                    <td>{{ r['End'] }}</td>
                    <td>{{ r['State'] }}</td>
                    <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                    <td>{{ r['GPU_Count'] }}</td>
                    <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                    <td>{{ '%.2f'|format(r['Memory_GB']) }}</td>
                    <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                    <td>{{ '%.2f'|format(r['Mem_GB_Hours_Alloc']) }}</td>
                    <td>{{ r['tier']|upper }}</td>
                    <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Collapsible: Raw fetched data -->
    <details class="raw">
        <summary>Show raw fetched data (parents + steps)</summary>
        {% if raw_cols and raw_rows %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        {% for c in raw_cols %}
                        <th class="{{ header_classes.get(c,'') }}">{{ c }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for r in raw_rows %}
                    <tr>
                        {% for c in raw_cols %}
                        <td>{{ r.get(c) }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="muted" style="margin-top:.25rem">Showing first {{ raw_rows|length }} row(s).</p>
        {% else %}
        <p class="muted">No raw rows.</p>
        {% endif %}
    </details>

    {% else %}
    <p class="muted">No jobs for the selected period.</p>
    {% endif %}

    {% elif view == 'aggregate' %}
    {% if agg_rows and agg_rows|length>0 %}
    <table>
        <thead>
            <tr>
                <th>Jobs</th>
                <th>CPU core-hrs</th>
                <th>GPU hrs</th>
                <th>Mem GB-hrs (used)</th>
                <th>Total Cost (฿)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in agg_rows %}
            <tr>
                <td>{{ r['jobs'] }}</td>
                <td>{{ '%.2f'|format(r['CPU_Core_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['GPU_Hours']) }}</td>
                <td>{{ '%.2f'|format(r['Mem_GB_Hours_Used']) }}</td>
                <td>฿{{ '%.2f'|format(r['Cost (฿)']) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- optional: raw collapsible also for aggregate view -->
    <details class="raw">
        <summary>Show raw fetched data (parents + steps)</summary>
        {% if raw_cols and raw_rows %}
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        {% for c in raw_cols %}
                        <th class="{{ header_classes.get(c,'') }}">{{ c }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for r in raw_rows %}
                    <tr>
                        {% for c in raw_cols %}
                        <td>{{ r.get(c) }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="muted" style="margin-top:.25rem">Showing first {{ raw_rows|length }} row(s).</p>
        {% else %}
        <p class="muted">No raw rows.</p>
        {% endif %}
    </details>

    {% else %}
    <p class="muted">No jobs for the selected period.</p>
    {% endif %}

    {% elif view == 'billed' %}
    {# keep your existing billed tables unchanged #}
    {{ super() }}
    {% else %}
    <p class="muted">Unknown view.</p>
    {% endif %}
</div>
{% endblock %}
