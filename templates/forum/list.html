{% extends "base.html" %}
{% block title %}Forum{% endblock %}
{% block content %}
{% macro name_with_admin(name) -%}
{{ name }}{% if name in page_admin_usernames %} <b>(Admin)</b>{% endif %}
{%- endmacro %}
<h2 class="page-title">Forum</h2>
<p><a class="btn" href="{{ url_for('forum.thread_new_form') }}"><button>New Thread</button></a></p>

{# helper for signed numbers #}
{% macro signed(n) -%}
{%- if n > 0 -%}+{{ n }}{%- else -%}{{ n }}{%- endif -%}
{%- endmacro %}

<h2>Forum</h2>

<form method="get" action="{{ url_for('forum.thread_list') }}" class="forum-filter">
    <input type="text" name="q" value="{{ q }}" placeholder="Search titleâ€¦" />
    <input type="text" name="op" value="{{ op }}" placeholder="OP (author)â€¦" />
    <label style="margin-left:.5rem;">
        <input type="checkbox" name="solved" value="1" {% if solved_only %}checked{% endif %}>
        Solved only
    </label>
    <button type="submit">Filter</button>
    {% if q or op or solved_only %}
    <a href="{{ url_for('forum.thread_list') }}" class="btn btn-sm" style="margin-left:.25rem;">Clear</a>
    {% endif %}
</form>

<ul class="forum-list">
    {% for t in threads %}
    {% set s = thread_scores.get(t.id, 0) %}
    <li>
        {% if t.is_pinned %}ðŸ“Œ{% endif %}
        <a href="{{ url_for('forum.thread_view', thread_id=t.id) }}">{{ t.title }}</a>
        {% if t.is_solved %}<span class="badge-solved">Solved</span>{% endif %}
        <span class="thread-score">({{ signed(s) }})</span>
        <small>by {{ name_with_admin(t.author_username) }} Â· {{ t.created_at|dt_local }}</small>
        {% if current_user.is_authenticated and current_user.role == 'admin' and not t.is_deleted %}
        <form method="post"
            action="{{ url_for('forum.thread_unpin' if t.is_pinned else 'forum.thread_pin', thread_id=t.id) }}"
            style="display:inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm">{{ 'Unpin' if t.is_pinned else 'Pin' }}</button>
        </form>
        {% endif %}
    </li>
    {% else %}
    <li>No threads found.</li>
    {% endfor %}
</ul>

{# Optional: simple prev/next using total/per_page, preserving filters #}
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav class="pager">
    {% if page > 1 %}
    <a
        href="{{ url_for('forum.thread_list') }}?page={{ page-1 }}&per_page={{ per_page }}{% if qs %}&{{ qs }}{% endif %}">Â«
        Prev</a>
    {% endif %}
    <span>Page {{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
    <a
        href="{{ url_for('forum.thread_list') }}?page={{ page+1 }}&per_page={{ per_page }}{% if qs %}&{{ qs }}{% endif %}">Next
        Â»</a>
    {% endif %}
</nav>
{% endif %}

{% endblock %}
