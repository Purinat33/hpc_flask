{% extends "base.html" %}
{% block title %}{{ thread.title }}{% endblock %}

{% block content %}
{# --- Helper: render username with (Admin) / (OP) labels --- #}
{% macro name_with_labels(name) -%}
{{ name }}
{% if name in admin_usernames %} <b>(Admin)</b>{% endif %}
{% if name == op_username %} <u>(OP)</u>{% endif %}
{%- endmacro %}
<h2>
{{ thread.title }}
{% if thread.is_locked %}
<span class="badge-locked" title="Thread is locked">ðŸ”’ Locked</span>
{% endif %}
{% if thread.is_pinned %}
<span class="badge-pinned" title="Pinned to top">ðŸ“Œ Pinned</span>
{% endif %}
{% if thread.is_solved %}<span class="badge-solved" title="Marked solved by OP">Solved</span>{% endif %}
</h2>
<p class="muted">by {{ name_with_labels(thread.author_username) }} Â· {{ thread.created_at|dt_local }}</p>

{% if current_user.is_authenticated and current_user.role == 'admin' and not thread.is_deleted %}
<form method="post"
    action="{{ url_for('forum.thread_unlock' if thread.is_locked else 'forum.thread_lock', thread_id=thread.id) }}"
    style="display:inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit">
        {{ 'Unlock' if thread.is_locked else 'Lock' }}
    </button>
</form>
{% endif %}
{% if current_user.is_authenticated and current_user.role == 'admin' and not thread.is_deleted %}
<form method="post"
    action="{{ url_for('forum.thread_unpin' if thread.is_pinned else 'forum.thread_pin', thread_id=thread.id) }}"
    style="display:inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit">{{ 'Unpin' if thread.is_pinned else 'Pin' }}</button>
</form>
{% endif %}
<a href="{{ url_for('forum.thread_list') }}"><button>Back</button></a>
<div class="post-body {{ 'muted' if thread.is_deleted }}">
    {{ '[Removed by an admin]' if thread.is_deleted and thread.deleted_by_admin else
     ('[Deleted]' if thread.is_deleted else thread.body) }}
</div>
{% if solved_snippets %}
<hr>
<div class="solved-box">
    <div class="solved-title">Marked Solutions</div>
    <ol class="solved-list">
        {% for s in solved_snippets %}
        <li>
            <span class="solved-author">{{ s.author }}</span> said:
            <blockquote class="solved-quote">
                {{ s.body }}
            </blockquote>
            <a href="#c{{ s.comment_id }}">Jump to original â†—</a>
            {% if current_user.is_authenticated and current_user.id == op_username and not thread.is_locked and not thread.is_deleted %}
            <form method="post"
                action="{{ url_for('forum.unmark_solution', thread_id=thread.id, comment_id=s.comment_id) }}"
                style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-xxs">Unmark</button>
            </form>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
</div>
{% endif %}


{% if current_user.is_authenticated and not thread.is_locked %}
<hr>
<form method="post" action="{{ url_for('forum.comment_create', thread_id=thread.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <textarea id="comment-main" class="textarea-grow" name="body" placeholder="Write a comment..." required
        maxlength="2000"></textarea>
    <div class="char-counter" aria-live="polite" data-for="comment-main">0/2000</div>
    <button type="submit">Reply</button>
</form>
{% endif %}


<hr>
<h3>Comments</h3>

{# Build a parent->children map from the flat list passed by the view #}
{% set by_parent = {} %}
{% for c in comments %}
{% set _ = by_parent.setdefault(c.parent_id, []).append(c) %}
{% endfor %}

{% macro render_comment(c, by_parent) -%}
<li id="c{{ c.id }}">
    <div>
        <b>{{ name_with_labels(c.author_username) }}</b> <small>{{ c.created_at|dt_local }}</small>
        {# replies count for toggle #}
        {% set kids = by_parent.get(c.id, []) %}
        {% if kids|length > 0 %}
        <button class="comment-toggle" type="button" aria-expanded="true" aria-controls="kids-{{ c.id }}"
            data-target="kids-{{ c.id }}" data-show="Show replies ({{ kids|length }})"
            data-hide="Hide replies ({{ kids|length }})">
            Hide replies ({{ kids|length }})
        </button>
        {% endif %}
    </div>

    <div class="comment-body {{ 'muted' if c.is_deleted }}">
        {{ '[Removed by an admin]' if c.is_deleted and c.deleted_by_admin else
         ('[Deleted]' if c.is_deleted else c.body) }}
    </div>

    {% if current_user.is_authenticated and not thread.is_locked %}
    <form method="post" action="{{ url_for('forum.comment_create', thread_id=thread.id) }}" style="margin-top:.5rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="parent_id" value="{{ c.id }}">
        <textarea id="reply-{{ c.id }}" class="textarea-grow" name="body" placeholder="Replyâ€¦" required
            maxlength="2000"></textarea>
        <div class="char-counter" aria-live="polite" data-for="reply-{{ c.id }}">0/2000</div>
        <button type="submit">Reply</button>
    </form>
    {% endif %}
    {% set is_solution_allowed = (current_user.is_authenticated
                                  and current_user.id == op_username
                                  and not thread.is_locked and not thread.is_deleted
                                  and not c.is_deleted) %}
    {% if is_solution_allowed %}
    {% set already = solved_snippets | selectattr('comment_id', 'equalto', c.id) | list | length > 0 %}
    {% if already %}
    <form method="post" action="{{ url_for('forum.unmark_solution', thread_id=thread.id, comment_id=c.id) }}"
        style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-xxs">Unmark solution</button>
    </form>
    {% else %}
    <form method="post" action="{{ url_for('forum.mark_solution', thread_id=thread.id, comment_id=c.id) }}"
        style="display:inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-xxs">Mark as solution</button>
    </form>
    {% endif %}
    {% endif %}


    {% if not thread.is_locked and current_user.is_authenticated
          and (current_user.role == 'admin' or current_user.id == c.author_username)
          and not c.is_deleted %}
    <form method="post" action="{{ url_for('forum.comment_delete', comment_id=c.id) }}" style="margin-top:.25rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Delete</button>
    </form>
    {% endif %}


    {# CHILDREN: collapsible container. Do NOT access c.children (avoids lazy-load) #}
    {% if kids %}
    <ul id="kids-{{ c.id }}" class="comment-children">
        {% for ch in kids %}
        {{ render_comment(ch, by_parent) }}
        {% endfor %}
    </ul>
    {% endif %}
</li>
{%- endmacro %}


<ul class="comments">
    {% for root in by_parent.get(None, []) %}
    {{ render_comment(root, by_parent) }}
    {% else %}
    <li class="muted">No comments yet.</li>
    {% endfor %}
</ul>

{% if current_user.is_authenticated and not thread.is_deleted %}
{% if (current_user.role == 'admin') or (not thread.is_locked and current_user.id == thread.author_username) %}
<hr>
<form method="post" action="{{ url_for('forum.thread_delete', thread_id=thread.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" onclick="return confirm('Mark this thread as deleted?')">Delete thread</button>
</form>
{% endif %}
{% endif %}

{% endblock %}
