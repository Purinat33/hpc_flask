{% extends "base.html" %}
{% block title %}MU AI Center{% endblock %}

{% block content %}
<h2>{{ _("MU AI Center Cost Calculator")}}</h2>
<!-- <p class="muted">Rates come from <code>/formula?type=...</code>. Use the Admin page to edit them.</p> -->
<div class="card">
  <div class="row">
    <div><label>{{ _("Customer type")}}</label>
      <select id="tier">
        <option value="mu">MU</option><option value="gov">Gov</option><option value="private">Private</option>
      </select></div>
    <div><label>{{ _("Duration amount")}}</label><input id="amount" type="number" min="1" step="1" value="1"></div>
  </div>
  <div class="row">
    <div><label>Duration unit</label>
      <select id="unit"><option value="hour">Hour(s)</option><option value="day">Day(s)</option><option value="month">Month(s)</option></select></div>
    <div><label>CPU cores</label><input id="cpu" type="number" min="0" step="1" value="1"></div>
  </div>
  <div class="row">
    <div><label>GPU count</label><input id="gpu" type="number" min="0" step="1" value="0"></div>
    <div><label>Memory (GB)</label><input id="mem" type="number" min="0" step="1" value="1"></div>
  </div>
  <div class="muted">
    <span class="pill" id="showCpuRate">cpu: —</span>
    <span class="pill" id="showGpuRate">gpu: —</span>
    <span class="pill" id="showMemRate">mem: —</span>
    <span class="pill" id="showUnit">unit: per-hour</span>
      <a style="margin-left:.5rem; font-size:.9rem; cursor:pointer" onclick="fetchRates(true)">↻ Refresh rates</a>
  </div>
  <div class="total" id="total">Total: ฿0.00</div>
  <div class="breakdown" id="breakdown"></div>
  <div id="error" style="color:#b00020;margin-top:.5rem"></div>
</div>
<footer class="site-footer">
  <div class="footer-left">
    <!-- optional: ©, links, etc. -->
  </div>
</footer>
<script>
  const $ = id => document.getElementById(id);
  const tierEl = $('tier'), amountEl = $('amount'), unitEl = $('unit'), cpuEl = $('cpu'), gpuEl = $('gpu'), memEl = $('mem');

  let rates = { cpu: 0, gpu: 0, mem: 0 };
  const etags = new Map(); // tier -> ETag string

  function hoursFrom(n, u) { n = Number(n) || 0; return u === 'day' ? n * 24 : u === 'month' ? n * 720 : n; }

  async function fetchRates(force = false) {
    $('error').textContent = "";
    const t = tierEl.value;
    try {
      const headers = {};
      const prev = etags.get(t);
      if (prev && !force) headers['If-None-Match'] = prev;

      const res = await fetch('/formula?type=' + encodeURIComponent(t), { headers });

      if (res.status === 304) {
        // unchanged — nothing to do
        return;
      }
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const etag = res.headers.get('ETag');
      if (etag) etags.set(t, etag);

      const d = await res.json();
      rates = d.rates || { cpu: 0, gpu: 0, mem: 0 };

      $('showCpuRate').textContent = `cpu: ฿${rates.cpu}/cpu-hour`;
      $('showGpuRate').textContent = `gpu: ฿${rates.gpu}/gpu-hour`;
      $('showMemRate').textContent = `mem: ฿${rates.mem}/GB-hour`;
      $('showUnit').textContent = 'unit: per-hour';
      recalc();
    } catch (e) {
      $('error').textContent = 'Failed to fetch rates: ' + e;
      rates = { cpu: 0, gpu: 0, mem: 0 };
      recalc();
    }
  }

  function recalc() {
    const hrs = hoursFrom(amountEl.value, unitEl.value);
    const cpuCost = (Number(cpuEl.value) || 0) * hrs * rates.cpu;
    const gpuCost = (Number(gpuEl.value) || 0) * hrs * rates.gpu;
    const memCost = (Number(memEl.value) || 0) * hrs * rates.mem;
    const total = cpuCost + gpuCost + memCost;
    $('total').textContent = `Total: ฿${total.toFixed(2)}`;
    $('breakdown').textContent = `CPU: ฿${cpuCost.toFixed(2)} | GPU: ฿${gpuCost.toFixed(2)} | MEM: ฿${memCost.toFixed(2)} (duration: ${hrs} h)`;
  }

  // Recalc on input; re-fetch rates when tier changes
  [tierEl, amountEl, unitEl, cpuEl, gpuEl, memEl].forEach(el => {
    el.addEventListener('input', () => { if (el === tierEl) fetchRates(true); else recalc(); });
    el.addEventListener('change', () => { if (el === tierEl) fetchRates(true); else recalc(); });
  });

  // Gentle polling (60s) using conditional GET (304 when unchanged)
  const POLL_MS = 60000;
  let pollTimer = setInterval(() => fetchRates(false), POLL_MS);

  // Refresh when tab gains focus (cheap & instant after admin updates)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) fetchRates(false);
  });

  // First load
  fetchRates(true);
</script>

{% endblock %}
